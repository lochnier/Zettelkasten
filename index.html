<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Zettelkasten</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Sora:wght@300;400;500;600;700&family=JetBrains+Mono:wght@300;400;500;600&family=Crimson+Pro:ital,wght@0,400;0,600;1,400&display=swap" rel="stylesheet">
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/marked/9.1.6/marked.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/d3/7.8.5/d3.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-dark.min.css">
<style>
  :root {
    --bg: #0e0e0f;
    --sidebar-bg: #141416;
    --sidebar-hover: #1c1c1f;
    --panel-bg: #18181b;
    --border: #2a2a2f;
    --border-light: #333338;
    --text: #e4e4e7;
    --text-muted: #71717a;
    --text-dim: #52525b;
    --accent: #c9a84c;
    --accent-hover: #d4b76a;
    --accent-dim: rgba(201,168,76,0.15);
    --accent-glow: rgba(201,168,76,0.08);
    --green: #4ade80;
    --blue: #60a5fa;
    --purple: #a78bfa;
    --red: #f87171;
    --orange: #fb923c;
    --editor-font: 'JetBrains Mono', monospace;
    --ui-font: 'Sora', sans-serif;
    --sidebar-width: 260px;
    --outline-width: 220px;
    --status-height: 28px;
    --toolbar-height: 42px;
  }
  [data-theme="light"] {
    --bg: #faf9f7;
    --sidebar-bg: #f2f0ec;
    --sidebar-hover: #e8e5df;
    --panel-bg: #ffffff;
    --border: #ddd9d0;
    --border-light: #e8e5df;
    --text: #1c1917;
    --text-muted: #78716c;
    --text-dim: #a8a29e;
    --accent: #b45309;
    --accent-hover: #92400e;
    --accent-dim: rgba(180,83,9,0.1);
    --accent-glow: rgba(180,83,9,0.05);
    --editor-font: 'JetBrains Mono', monospace;
  }
  * { box-sizing: border-box; margin: 0; padding: 0; }
  html, body { height: 100%; overflow: hidden; font-family: var(--ui-font); background: var(--bg); color: var(--text); }
  ::-webkit-scrollbar { width: 4px; height: 4px; }
  ::-webkit-scrollbar-track { background: transparent; }
  ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 2px; }
  ::-webkit-scrollbar-thumb:hover { background: var(--border-light); }

  /* ── LAYOUT ── */
  #app { display: flex; height: 100vh; overflow: hidden; }

  /* ── SIDEBAR ── */
  #sidebar {
    width: var(--sidebar-width);
    min-width: var(--sidebar-width);
    background: var(--sidebar-bg);
    border-right: 1px solid var(--border);
    display: flex;
    flex-direction: column;
    overflow: hidden;
    transition: width 0.2s ease;
    position: relative;
    z-index: 10;
  }
  #sidebar.collapsed { width: 0; min-width: 0; border-right: none; }
  #sidebar-header {
    padding: 12px 14px 10px;
    border-bottom: 1px solid var(--border);
    display: flex;
    align-items: center;
    gap: 8px;
    flex-shrink: 0;
  }
  #app-logo {
    width: 22px; height: 22px;
    background: var(--accent);
    border-radius: 4px;
    display: flex; align-items: center; justify-content: center;
    color: #0e0e0f;
    font-size: 11px; font-weight: 700; flex-shrink: 0;
  }
  #app-title { font-size: 13px; font-weight: 600; color: var(--text); letter-spacing: 0.02em; flex: 1; }
  #sidebar-actions { display: flex; gap: 2px; }
  .icon-btn {
    width: 28px; height: 28px;
    display: flex; align-items: center; justify-content: center;
    border-radius: 5px; border: none;
    background: transparent; color: var(--text-muted);
    cursor: pointer; font-size: 14px; transition: all 0.15s;
  }
  .icon-btn:hover { background: var(--sidebar-hover); color: var(--text); }
  .icon-btn.active { background: var(--accent-dim); color: var(--accent); }
  #sidebar-search {
    padding: 8px 12px;
    border-bottom: 1px solid var(--border);
    flex-shrink: 0;
  }
  #sidebar-search-input {
    width: 100%; background: var(--panel-bg);
    border: 1px solid var(--border); border-radius: 6px;
    padding: 5px 10px 5px 30px;
    font-size: 12px; font-family: var(--ui-font);
    color: var(--text); outline: none;
    transition: border-color 0.15s;
    position: relative;
  }
  #sidebar-search-input:focus { border-color: var(--accent); }
  .search-icon-wrap { position: relative; }
  .search-icon-wrap svg { position: absolute; left: 9px; top: 50%; transform: translateY(-50%); color: var(--text-dim); pointer-events: none; }
  #sidebar-scroll { flex: 1; overflow-y: auto; overflow-x: hidden; }

  /* sidebar sections */
  .sidebar-section { margin-bottom: 2px; }
  .sidebar-section-header {
    display: flex; align-items: center; justify-content: space-between;
    padding: 6px 14px 4px;
    cursor: pointer; user-select: none;
  }
  .sidebar-section-title {
    font-size: 10px; font-weight: 600; text-transform: uppercase;
    letter-spacing: 0.08em; color: var(--text-dim);
  }
  .sidebar-section-toggle { color: var(--text-dim); font-size: 10px; transition: transform 0.15s; }
  .sidebar-section-toggle.open { transform: rotate(90deg); }
  .sidebar-section-body { }
  .sidebar-section-body.collapsed { display: none; }

  .note-item {
    display: flex; align-items: center; gap: 6px;
    padding: 5px 14px;
    cursor: pointer; border-radius: 0;
    font-size: 12.5px; color: var(--text-muted);
    transition: all 0.1s; white-space: nowrap; overflow: hidden;
    text-overflow: ellipsis; position: relative;
  }
  .note-item:hover { background: var(--sidebar-hover); color: var(--text); }
  .note-item.active { background: var(--accent-dim); color: var(--accent); }
  .note-item .note-icon { font-size: 11px; flex-shrink: 0; }
  .note-item .note-title { flex: 1; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
  .note-item .note-actions { display: none; gap: 2px; flex-shrink: 0; }
  .note-item:hover .note-actions { display: flex; }
  .note-action-btn {
    width: 18px; height: 18px;
    display: flex; align-items: center; justify-content: center;
    border-radius: 3px; border: none; background: transparent;
    color: var(--text-dim); cursor: pointer; font-size: 10px;
    transition: all 0.1s;
  }
  .note-action-btn:hover { background: var(--border); color: var(--text); }
  .type-badge {
    font-size: 9px; padding: 1px 5px;
    border-radius: 3px; font-weight: 600; letter-spacing: 0.03em;
    flex-shrink: 0;
  }
  .type-fleeting { background: rgba(251,146,60,0.2); color: var(--orange); }
  .type-literature { background: rgba(96,165,250,0.2); color: var(--blue); }
  .type-permanent { background: rgba(74,222,128,0.2); color: var(--green); }

  /* folders */
  .folder-item {
    display: flex; align-items: center; gap: 5px;
    padding: 5px 14px;
    cursor: pointer; font-size: 12.5px; color: var(--text-muted);
    transition: all 0.1s;
  }
  .folder-item:hover { background: var(--sidebar-hover); color: var(--text); }
  .folder-icon { font-size: 11px; flex-shrink: 0; }
  .folder-label { font-size: 12.5px; flex: 1; }
  .folder-count { font-size: 10px; color: var(--text-dim); }
  .folder-children { padding-left: 14px; }
  .folder-children.collapsed { display: none; }
  .folder-toggle { font-size: 9px; color: var(--text-dim); transition: transform 0.15s; flex-shrink: 0; }
  .folder-toggle.open { transform: rotate(90deg); }

  /* tags */
  .tag-item {
    display: flex; align-items: center; justify-content: space-between;
    padding: 4px 14px;
    cursor: pointer; font-size: 12px; color: var(--text-muted);
    transition: all 0.1s;
  }
  .tag-item:hover { background: var(--sidebar-hover); color: var(--accent); }
  .tag-item.active { color: var(--accent); }
  .tag-name { display: flex; align-items: center; gap: 5px; }
  .tag-dot { width: 6px; height: 6px; border-radius: 50%; background: var(--accent); flex-shrink: 0; }
  .tag-count { font-size: 10px; background: var(--panel-bg); padding: 1px 5px; border-radius: 10px; }

  /* ── MAIN CONTENT ── */
  #main { flex: 1; display: flex; flex-direction: column; overflow: hidden; min-width: 0; }

  /* toolbar */
  #editor-toolbar {
    height: var(--toolbar-height);
    border-bottom: 1px solid var(--border);
    display: flex; align-items: center; padding: 0 12px; gap: 2px;
    flex-shrink: 0; background: var(--panel-bg);
  }
  .toolbar-sep { width: 1px; height: 18px; background: var(--border); margin: 0 4px; }
  .toolbar-btn {
    height: 28px; padding: 0 8px;
    display: flex; align-items: center; justify-content: center;
    border-radius: 5px; border: none; background: transparent;
    color: var(--text-muted); cursor: pointer;
    font-size: 12px; font-family: var(--ui-font); font-weight: 500;
    transition: all 0.15s; white-space: nowrap;
  }
  .toolbar-btn:hover { background: var(--sidebar-hover); color: var(--text); }
  .toolbar-btn.active { background: var(--accent-dim); color: var(--accent); }
  .toolbar-btn svg { width: 14px; height: 14px; }
  #toolbar-title-area { flex: 1; display: flex; align-items: center; gap: 8px; min-width: 0; }
  #note-title-display {
    font-size: 13px; color: var(--text-muted);
    white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
  }
  #toolbar-right { display: flex; align-items: center; gap: 2px; margin-left: auto; }

  /* editor area */
  #editor-area { flex: 1; display: flex; overflow: hidden; min-height: 0; }
  #editor-container { flex: 1; display: flex; flex-direction: column; overflow: hidden; min-width: 0; }

  #note-title-input {
    font-size: 28px; font-weight: 700;
    font-family: 'Crimson Pro', serif;
    color: var(--text); background: transparent; border: none;
    outline: none; width: 100%;
    padding: 24px 40px 8px;
    letter-spacing: -0.01em;
    line-height: 1.2;
  }
  #note-title-input::placeholder { color: var(--text-dim); }

  #note-meta-bar {
    display: flex; align-items: center; gap: 12px;
    padding: 0 40px 12px;
    font-size: 11.5px; color: var(--text-dim);
    flex-wrap: wrap;
  }
  .meta-item { display: flex; align-items: center; gap: 4px; }
  .meta-tag {
    background: var(--accent-dim); color: var(--accent);
    padding: 1px 7px; border-radius: 10px;
    font-size: 11px; cursor: pointer;
  }
  .meta-tag:hover { background: var(--accent); color: #0e0e0f; }
  #note-type-select {
    background: var(--panel-bg); border: 1px solid var(--border);
    color: var(--text-muted); border-radius: 4px;
    font-size: 11px; padding: 1px 4px; font-family: var(--ui-font);
    cursor: pointer; outline: none;
  }
  #note-folder-select {
    background: var(--panel-bg); border: 1px solid var(--border);
    color: var(--text-muted); border-radius: 4px;
    font-size: 11px; padding: 1px 4px; font-family: var(--ui-font);
    cursor: pointer; outline: none; max-width: 120px;
  }

  #editor-split { display: flex; flex: 1; overflow: hidden; min-height: 0; }
  #editor-pane, #preview-pane {
    flex: 1; overflow: hidden; display: flex; flex-direction: column; min-width: 0;
  }
  #editor-pane.hidden, #preview-pane.hidden { display: none; }
  #editor-pane + #preview-pane { border-left: 1px solid var(--border); }

  #markdown-editor {
    flex: 1; resize: none; border: none; outline: none;
    background: transparent; color: var(--text);
    font-family: var(--editor-font);
    font-size: 14px; line-height: 1.8;
    padding: 8px 40px 40px;
    tab-size: 2; overflow-y: auto;
    caret-color: var(--accent);
  }
  #markdown-editor::selection { background: var(--accent-dim); }

  #preview-content {
    flex: 1; overflow-y: auto;
    padding: 8px 40px 40px;
    font-family: 'Crimson Pro', serif;
    font-size: 17px; line-height: 1.8; color: var(--text);
  }

  /* markdown preview styles */
  .prose h1 { font-size: 2em; font-weight: 700; margin: 1.2em 0 0.4em; color: var(--text); letter-spacing: -0.02em; }
  .prose h2 { font-size: 1.5em; font-weight: 600; margin: 1em 0 0.3em; color: var(--text); }
  .prose h3 { font-size: 1.2em; font-weight: 600; margin: 0.8em 0 0.3em; color: var(--text); }
  .prose h4, .prose h5, .prose h6 { font-size: 1em; font-weight: 600; margin: 0.6em 0 0.2em; color: var(--text); }
  .prose p { margin-bottom: 0.8em; }
  .prose ul, .prose ol { padding-left: 1.5em; margin-bottom: 0.8em; }
  .prose li { margin-bottom: 0.2em; }
  .prose blockquote { border-left: 3px solid var(--accent); padding-left: 1em; margin: 1em 0; color: var(--text-muted); font-style: italic; }
  .prose code { font-family: var(--editor-font); font-size: 0.85em; background: var(--panel-bg); padding: 2px 6px; border-radius: 4px; color: var(--accent); }
  .prose pre { background: var(--panel-bg); border: 1px solid var(--border); border-radius: 8px; padding: 1em; margin: 1em 0; overflow-x: auto; }
  .prose pre code { background: transparent; padding: 0; color: var(--text); }
  .prose hr { border: none; border-top: 1px solid var(--border); margin: 1.5em 0; }
  .prose a { color: var(--accent); text-decoration: underline; text-underline-offset: 2px; }
  .prose a:hover { color: var(--accent-hover); }
  .prose strong { font-weight: 700; color: var(--text); }
  .prose em { font-style: italic; }
  .prose table { width: 100%; border-collapse: collapse; margin: 1em 0; font-size: 0.9em; }
  .prose th, .prose td { padding: 6px 12px; border: 1px solid var(--border); text-align: left; }
  .prose th { background: var(--panel-bg); font-weight: 600; }
  .prose input[type="checkbox"] { margin-right: 6px; accent-color: var(--accent); }
  .wiki-link { color: var(--accent); cursor: pointer; text-decoration: none; border-bottom: 1px dashed var(--accent); }
  .wiki-link:hover { background: var(--accent-dim); }
  .wiki-link-missing { color: var(--text-muted); border-bottom-color: var(--text-dim); }

  /* backlinks section */
  #backlinks-panel {
    border-top: 1px solid var(--border);
    padding: 16px 40px;
    flex-shrink: 0;
    background: var(--panel-bg);
  }
  #backlinks-title {
    font-size: 11px; font-weight: 600; text-transform: uppercase;
    letter-spacing: 0.08em; color: var(--text-dim); margin-bottom: 8px;
  }
  .backlink-item {
    font-size: 12.5px; color: var(--text-muted);
    cursor: pointer; padding: 3px 0;
    display: flex; align-items: center; gap: 6px;
    transition: color 0.1s;
  }
  .backlink-item:hover { color: var(--accent); }
  .backlink-excerpt { font-size: 11px; color: var(--text-dim); margin-left: 14px; }

  /* ── OUTLINE PANEL ── */
  #outline-panel {
    width: var(--outline-width);
    border-left: 1px solid var(--border);
    background: var(--sidebar-bg);
    display: flex; flex-direction: column; overflow: hidden;
    flex-shrink: 0; transition: width 0.2s;
  }
  #outline-panel.collapsed { width: 0; border-left: none; }
  #outline-header {
    padding: 10px 14px 8px;
    border-bottom: 1px solid var(--border);
    font-size: 10px; font-weight: 600; text-transform: uppercase;
    letter-spacing: 0.08em; color: var(--text-dim); flex-shrink: 0;
    display: flex; align-items: center; justify-content: space-between;
  }
  #outline-list { overflow-y: auto; padding: 8px 0; flex: 1; }
  .outline-item {
    padding: 3px 14px; font-size: 12px; color: var(--text-muted);
    cursor: pointer; transition: color 0.1s; white-space: nowrap;
    overflow: hidden; text-overflow: ellipsis;
  }
  .outline-item:hover { color: var(--accent); }
  .outline-h1 { padding-left: 14px; font-weight: 600; }
  .outline-h2 { padding-left: 22px; }
  .outline-h3 { padding-left: 30px; font-size: 11px; }
  .outline-h4, .outline-h5, .outline-h6 { padding-left: 38px; font-size: 11px; color: var(--text-dim); }

  /* ── STATUS BAR ── */
  #status-bar {
    height: var(--status-height);
    border-top: 1px solid var(--border);
    display: flex; align-items: center;
    padding: 0 16px; gap: 16px;
    font-size: 11px; color: var(--text-dim);
    background: var(--panel-bg); flex-shrink: 0;
  }
  .status-item { display: flex; align-items: center; gap: 4px; }
  #save-indicator { margin-left: auto; display: flex; align-items: center; gap: 4px; }
  .save-dot { width: 6px; height: 6px; border-radius: 50%; background: var(--green); }
  .save-dot.unsaved { background: var(--orange); }

  /* ── CITATION PANEL ── */
  #citation-panel {
    border-top: 1px solid var(--border);
    background: var(--panel-bg);
    flex-shrink: 0;
  }
  #citation-header {
    padding: 10px 40px;
    display: flex; align-items: center; justify-content: space-between;
    cursor: pointer; user-select: none;
  }
  #citation-header-left { display: flex; align-items: center; gap: 8px; }
  #citation-title-text {
    font-size: 11px; font-weight: 600; text-transform: uppercase;
    letter-spacing: 0.08em; color: var(--text-dim);
  }
  #citation-toggle-icon { color: var(--text-dim); font-size: 10px; transition: transform 0.15s; }
  #citation-toggle-icon.open { transform: rotate(90deg); }
  #citation-body {
    padding: 0 40px 20px;
    display: none;
  }
  #citation-body.open { display: block; }
  .citation-grid {
    display: grid; grid-template-columns: 1fr 1fr;
    gap: 8px; margin-bottom: 12px;
  }
  .citation-field-full { grid-column: 1 / -1; }
  .citation-label {
    font-size: 10.5px; font-weight: 600; color: var(--text-dim);
    margin-bottom: 3px; letter-spacing: 0.03em;
  }
  .citation-input, .citation-select {
    width: 100%; background: var(--bg);
    border: 1px solid var(--border); border-radius: 5px;
    padding: 5px 8px; font-size: 12px;
    font-family: var(--ui-font); color: var(--text);
    outline: none; transition: border-color 0.15s;
  }
  .citation-input:focus, .citation-select:focus { border-color: var(--accent); }
  #citation-preview {
    background: var(--bg); border: 1px solid var(--border);
    border-radius: 6px; padding: 12px 14px;
    font-size: 13px; font-family: 'Crimson Pro', serif;
    line-height: 1.6; color: var(--text-muted);
    margin-bottom: 10px; min-height: 48px;
  }
  #citation-preview em { font-style: italic; }
  .citation-actions { display: flex; gap: 8px; flex-wrap: wrap; }
  .citation-btn {
    padding: 5px 12px; border-radius: 5px; font-size: 12px;
    font-family: var(--ui-font); font-weight: 500;
    cursor: pointer; border: 1px solid var(--border);
    background: transparent; color: var(--text-muted);
    transition: all 0.15s;
  }
  .citation-btn:hover { border-color: var(--accent); color: var(--accent); }
  .citation-btn.primary { background: var(--accent); border-color: var(--accent); color: #0e0e0f; }
  .citation-btn.primary:hover { background: var(--accent-hover); }

  /* ── GRAPH VIEW ── */
  #graph-view {
    position: fixed; inset: 0; background: var(--bg);
    z-index: 100; display: none;
    flex-direction: column;
  }
  #graph-view.visible { display: flex; }
  #graph-header {
    height: 50px; border-bottom: 1px solid var(--border);
    display: flex; align-items: center; padding: 0 20px; gap: 12px;
    flex-shrink: 0; background: var(--panel-bg);
  }
  #graph-title { font-size: 14px; font-weight: 600; color: var(--text); }
  #graph-container { flex: 1; overflow: hidden; position: relative; }
  #graph-svg { width: 100%; height: 100%; }
  .graph-node { cursor: pointer; }
  .graph-node circle { transition: r 0.2s, stroke-width 0.2s; }
  .graph-node:hover circle { stroke-width: 3px; }
  .graph-node text { font-family: var(--ui-font); pointer-events: none; }
  .graph-link { stroke: var(--border); stroke-opacity: 0.6; }

  /* ── COMMAND PALETTE ── */
  #cmd-palette {
    position: fixed; top: 0; left: 0; right: 0; bottom: 0;
    background: rgba(0,0,0,0.6); backdrop-filter: blur(4px);
    z-index: 200; display: none;
    align-items: flex-start; justify-content: center;
    padding-top: 100px;
  }
  #cmd-palette.visible { display: flex; }
  #cmd-palette-inner {
    width: 560px; max-width: 90vw;
    background: var(--panel-bg); border: 1px solid var(--border);
    border-radius: 10px; overflow: hidden;
    box-shadow: 0 20px 60px rgba(0,0,0,0.5);
  }
  #cmd-input {
    width: 100%; background: transparent; border: none;
    border-bottom: 1px solid var(--border);
    padding: 14px 18px; font-size: 15px;
    font-family: var(--ui-font); color: var(--text);
    outline: none;
  }
  #cmd-results { max-height: 360px; overflow-y: auto; padding: 6px 0; }
  .cmd-item {
    display: flex; align-items: center; gap: 10px;
    padding: 9px 18px; cursor: pointer;
    font-size: 13px; color: var(--text-muted);
    transition: all 0.1s;
  }
  .cmd-item:hover, .cmd-item.selected {
    background: var(--accent-dim); color: var(--accent);
  }
  .cmd-item-icon { width: 20px; text-align: center; flex-shrink: 0; }
  .cmd-item-label { flex: 1; }
  .cmd-item-hint { font-size: 11px; color: var(--text-dim); }
  .cmd-section-label {
    padding: 8px 18px 4px; font-size: 10px; font-weight: 600;
    text-transform: uppercase; letter-spacing: 0.08em; color: var(--text-dim);
  }

  /* ── SEARCH PANEL ── */
  #search-panel {
    position: fixed; top: 0; left: 0; right: 0; bottom: 0;
    background: rgba(0,0,0,0.6); backdrop-filter: blur(4px);
    z-index: 200; display: none;
    align-items: flex-start; justify-content: center;
    padding-top: 80px;
  }
  #search-panel.visible { display: flex; }
  #search-inner {
    width: 680px; max-width: 90vw; max-height: 70vh;
    background: var(--panel-bg); border: 1px solid var(--border);
    border-radius: 10px; overflow: hidden;
    box-shadow: 0 20px 60px rgba(0,0,0,0.5);
    display: flex; flex-direction: column;
  }
  #search-input-wrap { padding: 14px 18px; border-bottom: 1px solid var(--border); display: flex; gap: 10px; align-items: center; }
  #global-search-input {
    flex: 1; background: transparent; border: none;
    font-size: 15px; font-family: var(--ui-font); color: var(--text);
    outline: none;
  }
  #search-results { overflow-y: auto; flex: 1; padding: 8px 0; }
  .search-result {
    padding: 10px 18px; cursor: pointer; border-bottom: 1px solid var(--border);
    transition: background 0.1s;
  }
  .search-result:hover { background: var(--sidebar-hover); }
  .search-result-title { font-size: 13px; font-weight: 600; color: var(--text); margin-bottom: 3px; }
  .search-result-excerpt { font-size: 12px; color: var(--text-muted); line-height: 1.5; }
  .search-highlight { background: var(--accent-dim); color: var(--accent); border-radius: 2px; padding: 0 2px; }

  /* ── SETTINGS MODAL ── */
  #settings-modal {
    position: fixed; inset: 0;
    background: rgba(0,0,0,0.6); backdrop-filter: blur(4px);
    z-index: 200; display: none;
    align-items: center; justify-content: center;
  }
  #settings-modal.visible { display: flex; }
  #settings-inner {
    width: 560px; max-width: 90vw; max-height: 80vh;
    background: var(--panel-bg); border: 1px solid var(--border);
    border-radius: 12px; overflow: hidden;
    box-shadow: 0 20px 60px rgba(0,0,0,0.5);
    display: flex; flex-direction: column;
  }
  #settings-header {
    padding: 18px 22px; border-bottom: 1px solid var(--border);
    display: flex; align-items: center; justify-content: space-between;
  }
  #settings-title { font-size: 16px; font-weight: 700; font-family: 'Crimson Pro', serif; }
  #settings-body { overflow-y: auto; padding: 20px 22px; }
  .settings-section { margin-bottom: 24px; }
  .settings-section-title {
    font-size: 10px; font-weight: 600; text-transform: uppercase;
    letter-spacing: 0.08em; color: var(--text-dim); margin-bottom: 12px;
  }
  .settings-row {
    display: flex; align-items: center; justify-content: space-between;
    padding: 8px 0; border-bottom: 1px solid var(--border);
  }
  .settings-row:last-child { border-bottom: none; }
  .settings-label { font-size: 13px; color: var(--text); }
  .settings-desc { font-size: 11px; color: var(--text-dim); margin-top: 2px; }
  .settings-control select, .settings-control input[type="text"],
  .settings-control input[type="number"], .settings-control textarea {
    background: var(--bg); border: 1px solid var(--border); border-radius: 5px;
    padding: 5px 8px; font-size: 12.5px; font-family: var(--ui-font);
    color: var(--text); outline: none; transition: border-color 0.15s;
  }
  .settings-control select:focus, .settings-control input:focus,
  .settings-control textarea:focus { border-color: var(--accent); }
  .settings-control textarea { width: 100%; resize: vertical; min-height: 80px; }
  .toggle-switch {
    width: 36px; height: 20px; border-radius: 10px;
    background: var(--border); cursor: pointer;
    position: relative; transition: background 0.2s;
    border: none; flex-shrink: 0;
  }
  .toggle-switch.on { background: var(--accent); }
  .toggle-switch::after {
    content: ''; position: absolute;
    width: 14px; height: 14px; border-radius: 50%;
    background: white; top: 3px; left: 3px;
    transition: transform 0.2s;
  }
  .toggle-switch.on::after { transform: translateX(16px); }

  /* ── BIBLIOGRAPHY VIEW ── */
  #bibliography-view {
    position: fixed; inset: 0; background: var(--bg);
    z-index: 100; display: none; flex-direction: column;
  }
  #bibliography-view.visible { display: flex; }
  #bibliography-header {
    height: 50px; border-bottom: 1px solid var(--border);
    display: flex; align-items: center; padding: 0 20px; gap: 12px;
    flex-shrink: 0; background: var(--panel-bg);
  }
  #bibliography-content { flex: 1; overflow-y: auto; max-width: 720px; margin: 0 auto; padding: 40px 20px; width: 100%; }
  #bibliography-title { font-family: 'Crimson Pro', serif; font-size: 28px; font-weight: 600; margin-bottom: 24px; color: var(--text); }
  .bib-entry {
    font-family: 'Crimson Pro', serif; font-size: 16px; line-height: 1.7;
    color: var(--text-muted); padding-left: 2em; text-indent: -2em;
    margin-bottom: 12px;
  }
  .bib-entry em { font-style: italic; }

  /* ── LIBRARY VIEW ── */
  #library-view {
    position: fixed; inset: 0; background: var(--bg);
    z-index: 100; display: none; flex-direction: column;
  }
  #library-view.visible { display: flex; }
  #library-header {
    height: 50px; border-bottom: 1px solid var(--border);
    display: flex; align-items: center; padding: 0 20px; gap: 12px;
    flex-shrink: 0; background: var(--panel-bg);
  }
  #library-body { flex: 1; display: flex; overflow: hidden; }
  #library-sidebar {
    width: 200px; border-right: 1px solid var(--border);
    background: var(--sidebar-bg); padding: 16px 0; flex-shrink: 0;
    overflow-y: auto;
  }
  .lib-filter-item {
    display: flex; align-items: center; justify-content: space-between;
    padding: 6px 16px; cursor: pointer; font-size: 12.5px;
    color: var(--text-muted); transition: all 0.1s; border-radius: 0;
  }
  .lib-filter-item:hover { background: var(--sidebar-hover); color: var(--text); }
  .lib-filter-item.active { background: var(--accent-dim); color: var(--accent); }
  .lib-filter-count { font-size: 10.5px; background: var(--panel-bg); padding: 1px 6px; border-radius: 10px; }
  .lib-filter-section { padding: 10px 16px 4px; font-size: 10px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.08em; color: var(--text-dim); }
  #library-main { flex: 1; display: flex; flex-direction: column; overflow: hidden; }
  #library-toolbar {
    padding: 12px 20px; border-bottom: 1px solid var(--border);
    display: flex; align-items: center; gap: 10px; flex-shrink: 0;
    background: var(--panel-bg);
  }
  #lib-search-input {
    flex: 1; background: var(--bg); border: 1px solid var(--border);
    border-radius: 6px; padding: 6px 12px; font-size: 13px;
    font-family: var(--ui-font); color: var(--text); outline: none;
    transition: border-color 0.15s;
  }
  #lib-search-input:focus { border-color: var(--accent); }
  #lib-sort-select {
    background: var(--bg); border: 1px solid var(--border); border-radius: 5px;
    padding: 5px 8px; font-size: 12px; font-family: var(--ui-font);
    color: var(--text-muted); outline: none; cursor: pointer;
  }
  .lib-view-toggle { display: flex; gap: 2px; }
  #library-grid { flex: 1; overflow-y: auto; padding: 20px; }

  /* Grid view */
  .lib-grid-layout { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 16px; }
  .lib-card {
    background: var(--panel-bg); border: 1px solid var(--border);
    border-radius: 10px; overflow: hidden; cursor: pointer;
    transition: all 0.2s; position: relative;
  }
  .lib-card:hover { border-color: var(--accent); transform: translateY(-2px); box-shadow: 0 8px 24px rgba(0,0,0,0.3); }
  .lib-card-cover {
    height: 140px; background: var(--sidebar-bg);
    display: flex; align-items: center; justify-content: center;
    font-size: 48px; position: relative; overflow: hidden;
  }
  .lib-card-cover img { width: 100%; height: 100%; object-fit: cover; }
  .lib-card-cover-placeholder { font-size: 40px; opacity: 0.4; }
  .lib-card-body { padding: 12px; }
  .lib-card-title { font-size: 13px; font-weight: 600; color: var(--text); margin-bottom: 3px; line-height: 1.3; }
  .lib-card-author { font-size: 11.5px; color: var(--text-muted); margin-bottom: 6px; }
  .lib-card-meta { display: flex; align-items: center; gap: 6px; flex-wrap: wrap; }
  .lib-type-badge {
    font-size: 9.5px; padding: 2px 6px; border-radius: 4px; font-weight: 600;
    letter-spacing: 0.03em; text-transform: uppercase;
  }
  .lib-type-book { background: rgba(167,139,250,0.2); color: var(--purple); }
  .lib-type-article { background: rgba(96,165,250,0.2); color: var(--blue); }
  .lib-type-film { background: rgba(251,146,60,0.2); color: var(--orange); }
  .lib-type-podcast { background: rgba(74,222,128,0.2); color: var(--green); }
  .lib-type-website { background: rgba(201,168,76,0.2); color: var(--accent); }
  .lib-type-other { background: rgba(113,113,122,0.2); color: var(--text-muted); }
  .lib-status-badge {
    font-size: 9.5px; padding: 2px 6px; border-radius: 4px; font-weight: 500;
  }
  .lib-status-read { background: rgba(74,222,128,0.15); color: var(--green); }
  .lib-status-reading { background: rgba(201,168,76,0.15); color: var(--accent); }
  .lib-status-want { background: rgba(113,113,122,0.15); color: var(--text-muted); }
  .lib-status-abandoned { background: rgba(248,113,113,0.15); color: var(--red); }
  .lib-rating { color: var(--accent); font-size: 11px; letter-spacing: 1px; }
  .lib-linked-count { font-size: 10px; color: var(--text-dim); display: flex; align-items: center; gap: 3px; }

  /* List view */
  .lib-list-layout { display: flex; flex-direction: column; gap: 0; }
  .lib-row {
    display: flex; align-items: center; gap: 14px;
    padding: 10px 16px; border-bottom: 1px solid var(--border);
    cursor: pointer; transition: background 0.1s;
  }
  .lib-row:hover { background: var(--sidebar-hover); }
  .lib-row-icon { font-size: 22px; width: 32px; text-align: center; flex-shrink: 0; }
  .lib-row-info { flex: 1; min-width: 0; }
  .lib-row-title { font-size: 13.5px; font-weight: 600; color: var(--text); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
  .lib-row-sub { font-size: 11.5px; color: var(--text-muted); margin-top: 1px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
  .lib-row-right { display: flex; align-items: center; gap: 8px; flex-shrink: 0; }
  .lib-row-isbn { font-size: 10.5px; color: var(--text-dim); font-family: var(--editor-font); }
  .lib-row-actions { display: none; gap: 2px; }
  .lib-row:hover .lib-row-actions { display: flex; }
  .lib-action-btn {
    width: 24px; height: 24px; border-radius: 4px; border: none;
    background: transparent; color: var(--text-dim);
    cursor: pointer; font-size: 11px; display: flex; align-items: center; justify-content: center;
    transition: all 0.1s;
  }
  .lib-action-btn:hover { background: var(--border); color: var(--text); }

  /* Library empty state */
  #lib-empty { text-align: center; padding: 60px 20px; color: var(--text-dim); }
  #lib-empty h3 { font-family: 'Crimson Pro', serif; font-size: 24px; font-weight: 400; margin-bottom: 8px; color: var(--text-muted); }

  /* ── LIBRARY ITEM MODAL ── */
  #lib-item-modal {
    position: fixed; inset: 0; background: rgba(0,0,0,0.65);
    backdrop-filter: blur(4px); z-index: 300;
    display: none; align-items: center; justify-content: center;
  }
  #lib-item-modal.visible { display: flex; }
  #lib-item-inner {
    width: 680px; max-width: 95vw; max-height: 92vh;
    background: var(--panel-bg); border: 1px solid var(--border);
    border-radius: 12px; overflow: hidden;
    box-shadow: 0 24px 80px rgba(0,0,0,0.6);
    display: flex; flex-direction: column;
  }
  #lib-item-header {
    padding: 18px 22px 14px; border-bottom: 1px solid var(--border);
    display: flex; align-items: center; justify-content: space-between; flex-shrink: 0;
  }
  #lib-item-title-text { font-size: 16px; font-weight: 700; font-family: 'Crimson Pro', serif; color: var(--text); }
  #lib-item-body { overflow-y: auto; padding: 20px 22px; flex: 1; }
  .lib-form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 14px; }
  .lib-form-full { grid-column: 1 / -1; }
  .lib-form-label { font-size: 10.5px; font-weight: 600; color: var(--text-dim); margin-bottom: 4px; letter-spacing: 0.04em; text-transform: uppercase; }
  .lib-form-input, .lib-form-select, .lib-form-textarea {
    width: 100%; background: var(--bg); border: 1px solid var(--border);
    border-radius: 6px; padding: 7px 10px; font-size: 13px;
    font-family: var(--ui-font); color: var(--text); outline: none;
    transition: border-color 0.15s;
  }
  .lib-form-input:focus, .lib-form-select:focus, .lib-form-textarea:focus { border-color: var(--accent); }
  .lib-form-textarea { resize: vertical; min-height: 80px; }
  .isbn-row { display: flex; gap: 6px; align-items: flex-end; }
  .isbn-lookup-btn {
    padding: 7px 12px; background: var(--accent-dim); border: 1px solid var(--accent);
    border-radius: 6px; color: var(--accent); font-size: 12px;
    font-family: var(--ui-font); cursor: pointer; white-space: nowrap;
    transition: all 0.15s; flex-shrink: 0;
  }
  .isbn-lookup-btn:hover { background: var(--accent); color: #0e0e0f; }
  .isbn-openlibrary-btn {
    padding: 7px 10px; background: transparent; border: 1px solid var(--border);
    border-radius: 6px; color: var(--text-muted); font-size: 12px;
    font-family: var(--ui-font); cursor: pointer; white-space: nowrap;
    transition: all 0.15s; flex-shrink: 0;
    display: flex; align-items: center; gap: 4px;
    text-decoration: none;
  }
  .isbn-openlibrary-btn:hover { border-color: var(--accent); color: var(--accent); }
  .lib-rating-input { display: flex; gap: 4px; align-items: center; }
  .lib-star-btn {
    background: none; border: none; cursor: pointer;
    font-size: 18px; padding: 2px; color: var(--border); transition: color 0.1s;
    line-height: 1;
  }
  .lib-star-btn.on { color: var(--accent); }
  .lib-star-btn:hover { color: var(--accent); }
  #lib-linked-notes-section { margin-top: 16px; border-top: 1px solid var(--border); padding-top: 16px; }
  .lib-linked-notes-title { font-size: 10.5px; font-weight: 600; color: var(--text-dim); text-transform: uppercase; letter-spacing: 0.04em; margin-bottom: 10px; }
  #lib-linked-notes-list { display: flex; flex-direction: column; gap: 4px; }
  .lib-linked-note-row {
    display: flex; align-items: center; gap: 8px;
    padding: 6px 10px; background: var(--bg);
    border: 1px solid var(--border); border-radius: 6px;
    font-size: 12.5px; color: var(--text-muted);
  }
  .lib-linked-note-row:hover { border-color: var(--accent); color: var(--text); }
  .lib-linked-note-title { flex: 1; cursor: pointer; }
  .lib-linked-note-title:hover { color: var(--accent); }
  .lib-unlink-btn { background: none; border: none; cursor: pointer; color: var(--text-dim); font-size: 12px; }
  .lib-unlink-btn:hover { color: var(--red); }
  #lib-note-search-row { display: flex; gap: 6px; margin-top: 8px; }
  #lib-note-search {
    flex: 1; background: var(--bg); border: 1px solid var(--border);
    border-radius: 5px; padding: 5px 8px; font-size: 12px;
    font-family: var(--ui-font); color: var(--text); outline: none;
  }
  #lib-note-search:focus { border-color: var(--accent); }
  #lib-note-search-results {
    position: absolute; background: var(--panel-bg); border: 1px solid var(--border);
    border-radius: 6px; width: 320px; max-height: 160px; overflow-y: auto;
    box-shadow: 0 8px 24px rgba(0,0,0,0.4); z-index: 400;
    display: none;
  }
  #lib-note-search-results.visible { display: block; }
  .lib-note-suggestion {
    padding: 7px 12px; cursor: pointer; font-size: 12.5px; color: var(--text-muted);
    transition: all 0.1s;
  }
  .lib-note-suggestion:hover { background: var(--accent-dim); color: var(--accent); }
  .lib-item-footer {
    padding: 14px 22px; border-top: 1px solid var(--border);
    display: flex; align-items: center; justify-content: space-between; flex-shrink: 0;
  }
  .lib-save-btn {
    padding: 8px 20px; background: var(--accent); border: none; border-radius: 6px;
    color: #0e0e0f; font-size: 13px; font-family: var(--ui-font); font-weight: 600;
    cursor: pointer; transition: background 0.15s;
  }
  .lib-save-btn:hover { background: var(--accent-hover); }
  .lib-delete-btn {
    padding: 7px 14px; background: transparent; border: 1px solid var(--border);
    border-radius: 6px; color: var(--text-dim); font-size: 12px;
    font-family: var(--ui-font); cursor: pointer; transition: all 0.15s;
  }
  .lib-delete-btn:hover { border-color: var(--red); color: var(--red); }
  #isbn-lookup-result {
    font-size: 11.5px; color: var(--green); margin-top: 5px;
    display: none; padding: 4px 8px; background: rgba(74,222,128,0.1);
    border-radius: 4px; border: 1px solid rgba(74,222,128,0.3);
  }

  /* ── TOAST ── */
  #toast-container {
    position: fixed; bottom: 40px; right: 20px;
    z-index: 9999; display: flex; flex-direction: column-reverse; gap: 8px;
  }
  .toast {
    background: var(--panel-bg); border: 1px solid var(--border);
    border-radius: 8px; padding: 10px 16px;
    font-size: 13px; color: var(--text);
    box-shadow: 0 4px 20px rgba(0,0,0,0.3);
    display: flex; align-items: center; gap: 8px;
    animation: toastIn 0.25s ease;
    max-width: 320px;
  }
  .toast.success { border-left: 3px solid var(--green); }
  .toast.error { border-left: 3px solid var(--red); }
  .toast.info { border-left: 3px solid var(--accent); }
  @keyframes toastIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
  @keyframes toastOut { from { opacity: 1; } to { opacity: 0; transform: translateY(10px); } }

  /* ── EMPTY STATE ── */
  #empty-state {
    flex: 1; display: flex; flex-direction: column;
    align-items: center; justify-content: center;
    color: var(--text-dim); text-align: center;
    padding: 40px;
  }
  #empty-state h2 { font-family: 'Crimson Pro', serif; font-size: 28px; font-weight: 400; margin-bottom: 8px; color: var(--text-muted); }
  #empty-state p { font-size: 14px; margin-bottom: 20px; }
  #empty-state kbd {
    background: var(--panel-bg); border: 1px solid var(--border);
    padding: 2px 8px; border-radius: 4px; font-size: 11px;
    font-family: var(--editor-font);
  }

  /* find in note */
  #find-bar {
    background: var(--panel-bg); border-top: 1px solid var(--border);
    padding: 6px 14px; display: none; align-items: center; gap: 8px;
    flex-shrink: 0;
  }
  #find-bar.visible { display: flex; }
  #find-input {
    flex: 1; background: var(--bg); border: 1px solid var(--border);
    border-radius: 5px; padding: 4px 8px; font-size: 12px;
    font-family: var(--ui-font); color: var(--text); outline: none;
  }
  #find-input:focus { border-color: var(--accent); }
  #find-count { font-size: 11px; color: var(--text-dim); white-space: nowrap; }

  /* split view divider */
  .split-divider { width: 4px; background: var(--border); cursor: col-resize; flex-shrink: 0; transition: background 0.1s; }
  .split-divider:hover { background: var(--accent); }

  /* welcome screen keys */
  .shortcut-table { font-size: 12px; }
  .shortcut-row { display: flex; justify-content: space-between; padding: 3px 0; color: var(--text-dim); }
  .shortcut-row kbd { font-family: var(--editor-font); font-size: 11px; background: var(--panel-bg); padding: 1px 6px; border-radius: 3px; border: 1px solid var(--border); }

  /* note not found banner */
  .link-not-found-banner {
    background: rgba(251,146,60,0.1); border: 1px solid rgba(251,146,60,0.3);
    border-radius: 6px; padding: 8px 12px; margin-bottom: 12px;
    font-size: 12.5px; color: var(--orange);
    display: flex; align-items: center; gap: 8px;
  }

  /* new folder dialog embedded */
  .inline-input {
    background: var(--bg); border: 1px solid var(--border);
    border-radius: 5px; padding: 4px 8px; font-size: 12px;
    font-family: var(--ui-font); color: var(--text); outline: none;
    width: calc(100% - 28px); margin: 4px 14px;
  }
  .inline-input:focus { border-color: var(--accent); }

  /* calendar widget */
  #calendar-widget { padding: 8px 12px; }
  .cal-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 6px; }
  .cal-title { font-size: 11.5px; font-weight: 600; color: var(--text-muted); }
  .cal-nav { font-size: 12px; cursor: pointer; color: var(--text-dim); background: none; border: none; padding: 2px 5px; border-radius: 3px; }
  .cal-nav:hover { color: var(--text); background: var(--sidebar-hover); }
  .cal-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 1px; }
  .cal-day-name { font-size: 9px; text-align: center; color: var(--text-dim); padding: 2px 0; font-weight: 600; }
  .cal-day {
    font-size: 10.5px; text-align: center; padding: 3px 1px;
    border-radius: 3px; cursor: pointer; color: var(--text-dim);
  }
  .cal-day:hover { background: var(--sidebar-hover); color: var(--text); }
  .cal-day.today { background: var(--accent-dim); color: var(--accent); font-weight: 600; }
  .cal-day.has-note { color: var(--text); }
  .cal-day.empty { cursor: default; }

  /* ── SPLIT DRAG HANDLE ── */
  #split-drag-handle {
    width: 5px; cursor: col-resize; flex-shrink: 0;
    background: var(--border); transition: background 0.15s;
    position: relative; z-index: 10;
    display: none;
  }
  #split-drag-handle:hover, #split-drag-handle.dragging { background: var(--accent); }
  #split-drag-handle::after {
    content: ''; position: absolute; inset: 0 -4px;
  }

  /* ── SIDEBAR RESIZE HANDLE ── */
  #sidebar-resize-handle {
    width: 4px; cursor: col-resize; flex-shrink: 0;
    background: transparent; transition: background 0.15s;
    position: absolute; right: 0; top: 0; bottom: 0; z-index: 20;
  }
  #sidebar:hover #sidebar-resize-handle,
  #sidebar-resize-handle.dragging { background: var(--accent-dim); }

  /* ── GRAPH HOVER CARD ── */
  #graph-hover-card {
    position: fixed; background: var(--panel-bg);
    border: 1px solid var(--border); border-radius: 8px;
    padding: 10px 14px; min-width: 180px; max-width: 260px;
    box-shadow: 0 8px 24px rgba(0,0,0,0.4);
    pointer-events: none; display: none; z-index: 200;
    font-size: 12.5px;
  }
  #graph-hover-card.visible { display: block; }
  .ghc-title { font-weight: 600; color: var(--text); margin-bottom: 4px; font-size: 13px; }
  .ghc-meta { color: var(--text-dim); font-size: 11px; margin-bottom: 5px; }
  .ghc-excerpt { color: var(--text-muted); font-size: 11.5px; line-height: 1.5; }
  .ghc-hint { font-size: 10px; color: var(--accent); margin-top: 6px; }

  /* ── GRAPH TAG FILTER ── */
  #graph-tag-filter {
    background: var(--panel-bg); border: 1px solid var(--border);
    color: var(--text); padding: 3px 6px; border-radius: 4px;
    font-size: 11px; font-family: var(--ui-font); outline: none;
    max-width: 130px;
  }

  /* ── SEARCH IMPROVEMENTS ── */
  #search-filters {
    display: flex; gap: 6px; padding: 8px 16px 0;
    flex-wrap: wrap; align-items: center;
  }
  .search-filter-btn {
    padding: 3px 10px; border-radius: 12px; border: 1px solid var(--border);
    background: transparent; color: var(--text-muted); font-size: 11px;
    font-family: var(--ui-font); cursor: pointer; transition: all 0.15s;
  }
  .search-filter-btn:hover { border-color: var(--accent); color: var(--accent); }
  .search-filter-btn.active { background: var(--accent-dim); border-color: var(--accent); color: var(--accent); }
  #search-stats { font-size: 11px; color: var(--text-dim); padding: 4px 16px 0; }

  /* ── CITATION "IMPORT FROM LIBRARY" ── */
  .cite-import-btn {
    padding: 5px 10px; background: var(--accent-dim); border: 1px solid var(--border);
    border-radius: 5px; color: var(--accent); font-size: 11.5px;
    font-family: var(--ui-font); cursor: pointer; transition: all 0.15s;
    display: flex; align-items: center; gap: 5px;
  }
  .cite-import-btn:hover { border-color: var(--accent); background: var(--accent); color: #0e0e0f; }
  #lib-import-dropdown {
    position: absolute; background: var(--panel-bg); border: 1px solid var(--border);
    border-radius: 8px; width: 320px; max-height: 220px; overflow-y: auto;
    box-shadow: 0 8px 24px rgba(0,0,0,0.4); z-index: 400; display: none;
    bottom: calc(100% + 4px); left: 0;
  }
  #lib-import-dropdown.visible { display: block; }
  .lib-import-item {
    display: flex; align-items: center; gap: 8px; padding: 8px 12px;
    cursor: pointer; font-size: 12.5px; color: var(--text-muted);
    transition: all 0.1s; border-bottom: 1px solid var(--border);
  }
  .lib-import-item:last-child { border-bottom: none; }
  .lib-import-item:hover { background: var(--accent-dim); color: var(--text); }
  .lib-import-icon { font-size: 16px; flex-shrink: 0; }
  .lib-import-info { flex: 1; min-width: 0; }
  .lib-import-title { font-weight: 600; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
  .lib-import-sub { font-size: 10.5px; color: var(--text-dim); }

  /* ── INLINE CITATION INSERT ── */
  #inline-cite-btn { font-size: 10.5px; }

  /* ── BACKUP REMINDER ── */
  #backup-banner {
    position: fixed; bottom: 0; left: 0; right: 0;
    background: var(--panel-bg); border-top: 1px solid var(--accent);
    padding: 10px 20px; z-index: 500;
    display: none; align-items: center; gap: 12px; font-size: 13px;
  }
  #backup-banner.visible { display: flex; }
  .backup-close { margin-left: auto; cursor: pointer; color: var(--text-dim); font-size: 16px; }
  .backup-close:hover { color: var(--text); }

  /* ── SIDEBAR TAG ACTIVE FILTER ── */
  #active-tag-filter {
    display: none; margin: 4px 8px; padding: 4px 10px;
    background: var(--accent-dim); border: 1px solid var(--accent);
    border-radius: 6px; font-size: 11px; color: var(--accent);
    cursor: pointer; align-items: center; gap: 6px;
  }
  #active-tag-filter.visible { display: flex; }
  #active-tag-filter .clear-tag { font-size: 12px; }

  /* ── MOBILE ── */
  @media (max-width: 700px) {
    #sidebar { width: 100vw !important; position: fixed; left: -100vw; top: 0; bottom: 0; z-index: 200; transition: left 0.25s; border-right: none; }
    #sidebar.mobile-open { left: 0; box-shadow: 4px 0 30px rgba(0,0,0,0.5); }
    #main { flex: 1; min-width: 0; }
    #outline-panel { display: none !important; }
    #editor-split { flex-direction: column !important; }
    #preview-pane { min-height: 40vh; }
    #split-drag-handle { display: none !important; }
    .toolbar-btn { padding: 4px 5px; font-size: 10px; }
    #toolbar-title-area { display: none; }
    #mobile-sidebar-overlay {
      display: none; position: fixed; inset: 0;
      background: rgba(0,0,0,0.5); z-index: 199;
    }
    #mobile-sidebar-overlay.visible { display: block; }
  }

  /* ── NOTE SORT CONTROL ── */
  .sidebar-section-sort {
    display: flex; align-items: center; gap: 4px;
  }
  .sidebar-sort-select {
    background: transparent; border: none; color: var(--text-dim);
    font-size: 9.5px; font-family: var(--ui-font); outline: none;
    cursor: pointer; padding: 1px 2px;
  }
  .sidebar-sort-select:hover { color: var(--accent); }

  /* ── HELP MODAL ── */
  #help-modal {
    position: fixed; inset: 0; background: rgba(0,0,0,0.65);
    backdrop-filter: blur(4px); z-index: 300;
    display: none; align-items: center; justify-content: center;
  }
  #help-modal.visible { display: flex; }
  #help-inner {
    width: 680px; max-width: 95vw; max-height: 90vh;
    background: var(--panel-bg); border: 1px solid var(--border);
    border-radius: 14px; overflow: hidden;
    box-shadow: 0 24px 80px rgba(0,0,0,0.6);
    display: flex; flex-direction: column;
  }
  #help-header {
    padding: 20px 24px 16px; border-bottom: 1px solid var(--border);
    display: flex; align-items: center; justify-content: space-between; flex-shrink: 0;
    background: var(--panel-bg);
  }
  #help-header-left { display: flex; align-items: center; gap: 10px; }
  #help-header-icon {
    width: 34px; height: 34px; border-radius: 8px;
    background: var(--accent-dim); border: 1px solid var(--accent);
    display: flex; align-items: center; justify-content: center;
    font-size: 17px; color: var(--accent);
  }
  #help-header-title { font-size: 16px; font-weight: 700; color: var(--text); }
  #help-header-sub { font-size: 11.5px; color: var(--text-dim); margin-top: 1px; }
  #help-body { overflow-y: auto; padding: 20px 24px; flex: 1; }
  .help-section { margin-bottom: 24px; }
  .help-section-title {
    font-size: 10px; font-weight: 700; text-transform: uppercase;
    letter-spacing: 0.1em; color: var(--text-dim);
    margin-bottom: 10px; padding-bottom: 6px;
    border-bottom: 1px solid var(--border);
  }
  .help-grid {
    display: grid; grid-template-columns: 1fr 1fr; gap: 4px 16px;
  }
  .help-row {
    display: flex; align-items: center; justify-content: space-between;
    padding: 5px 8px; border-radius: 6px; transition: background 0.1s;
  }
  .help-row:hover { background: var(--sidebar-hover); }
  .help-label { font-size: 12.5px; color: var(--text-muted); }
  .help-keys { display: flex; gap: 3px; align-items: center; flex-shrink: 0; }
  .help-key {
    display: inline-block; padding: 2px 7px;
    background: var(--bg); border: 1px solid var(--border-light);
    border-bottom-width: 2px; border-radius: 5px;
    font-family: var(--editor-font); font-size: 10.5px;
    color: var(--text-muted); white-space: nowrap;
  }
  .help-key.accent { border-color: var(--accent); color: var(--accent); background: var(--accent-dim); }
  .help-plus { font-size: 10px; color: var(--text-dim); }
  .help-footer {
    padding: 14px 24px; border-top: 1px solid var(--border);
    display: flex; align-items: center; justify-content: space-between; flex-shrink: 0;
    background: var(--sidebar-bg);
  }
  .help-footer-tip { font-size: 11.5px; color: var(--text-dim); display: flex; align-items: center; gap: 6px; }
  .help-close-btn {
    padding: 7px 18px; background: var(--accent); border: none;
    border-radius: 6px; color: #0e0e0f; font-size: 13px;
    font-family: var(--ui-font); font-weight: 600; cursor: pointer;
    transition: background 0.15s;
  }
  .help-close-btn:hover { background: var(--accent-hover); }
  @media (max-width: 600px) { .help-grid { grid-template-columns: 1fr; } }

  /* util */
  .hidden { display: none !important; }
  .fade-in { animation: fadeIn 0.2s ease; }
  @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
</style>
</head>
<body>
<div id="app">
  <!-- Mobile overlay -->
  <div id="mobile-sidebar-overlay" onclick="closeMobileSidebar()"></div>

  <!-- ══ SIDEBAR ══ -->
  <div id="sidebar">
    <div id="sidebar-resize-handle" title="Drag to resize sidebar"></div>
    <div id="sidebar-header">
      <div id="app-logo">Z</div>
      <span id="app-title">Zettelkasten</span>
      <div id="sidebar-actions">
        <button class="icon-btn" onclick="createNote()" title="New Note (Alt+N)">
          <svg viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M3 8h10M8 3v10"/></svg>
        </button>
        <button class="icon-btn" onclick="openDailyNote()" title="Daily Note (Alt+D)">
          <svg viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.5"><rect x="2" y="3" width="12" height="11" rx="1.5"/><path d="M5 2v2M11 2v2M2 7h12"/></svg>
        </button>
        <button class="icon-btn" onclick="toggleTheme()" title="Toggle Theme" id="theme-btn">
          <svg viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M8 2v1M8 13v1M2 8H1M15 8h-1M4.2 4.2l-.7-.7M12.5 12.5l-.7-.7M4.2 11.8l-.7.7M12.5 3.5l-.7.7" stroke-linecap="round"/><circle cx="8" cy="8" r="3"/></svg>
        </button>
      </div>
    </div>

    <div id="sidebar-search">
      <div class="search-icon-wrap">
        <svg width="12" height="12" viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="2"><circle cx="7" cy="7" r="4"/><path d="M11 11l3 3" stroke-linecap="round"/></svg>
        <input id="sidebar-search-input" placeholder="Search notes… (Alt+F)" oninput="sidebarSearchFilter(this.value)" onfocus="if(event.ctrlKey||event.metaKey){}">
      </div>
    </div>

    <div id="sidebar-scroll">
      <!-- Starred -->
      <div class="sidebar-section" id="section-starred">
        <div class="sidebar-section-header" onclick="toggleSection('starred')">
          <span class="sidebar-section-title">⭐ Starred</span>
          <span class="sidebar-section-toggle open" id="toggle-starred">▶</span>
        </div>
        <div class="sidebar-section-body" id="body-starred"></div>
      </div>

      <!-- Folders + Notes -->
      <div class="sidebar-section" id="section-folders">
        <div class="sidebar-section-header" style="cursor:default;">
          <span class="sidebar-section-title">📁 Notes</span>
          <div class="sidebar-section-sort">
            <select class="sidebar-sort-select" id="notes-sort-select" onchange="renderFolderTree()" title="Sort notes">
              <option value="modified">Modified</option>
              <option value="created">Created</option>
              <option value="title">Title</option>
              <option value="type">Type</option>
            </select>
            <button class="icon-btn" style="width:20px;height:20px;font-size:10px;" onclick="promptNewFolder()" title="New Folder">+📁</button>
          </div>
        </div>
        <div id="active-tag-filter" onclick="clearTagFilter()">
          <span>🏷 <span id="active-tag-text"></span></span>
          <span class="clear-tag" title="Clear filter">✕</span>
        </div>
        <div id="body-folders"></div>
      </div>

      <!-- Tags -->
      <div class="sidebar-section" id="section-tags">
        <div class="sidebar-section-header" onclick="toggleSection('tags')">
          <span class="sidebar-section-title"># Tags</span>
          <span class="sidebar-section-toggle open" id="toggle-tags">▶</span>
        </div>
        <div class="sidebar-section-body" id="body-tags"></div>
      </div>

      <!-- Recent -->
      <div class="sidebar-section" id="section-recent">
        <div class="sidebar-section-header" onclick="toggleSection('recent')">
          <span class="sidebar-section-title">🕐 Recent</span>
          <span class="sidebar-section-toggle open" id="toggle-recent">▶</span>
        </div>
        <div class="sidebar-section-body" id="body-recent"></div>
      </div>

      <!-- Calendar -->
      <div class="sidebar-section" id="section-calendar">
        <div class="sidebar-section-header" onclick="toggleSection('calendar')">
          <span class="sidebar-section-title">📅 Calendar</span>
          <span class="sidebar-section-toggle" id="toggle-calendar">▶</span>
        </div>
        <div class="sidebar-section-body collapsed" id="body-calendar">
          <div id="calendar-widget"></div>
        </div>
      </div>

      <!-- Bibliography -->
      <div class="sidebar-section">
        <div class="sidebar-section-header" style="cursor:pointer;" onclick="showBibliography()">
          <span class="sidebar-section-title">📚 Bibliography</span>
          <span style="font-size:10px;color:var(--text-dim);">→</span>
        </div>
      </div>

      <!-- Library -->
      <div class="sidebar-section">
        <div class="sidebar-section-header" style="cursor:default;">
          <span class="sidebar-section-title">🗂 Library</span>
          <div style="display:flex;gap:2px;align-items:center;">
            <span id="lib-sidebar-count" style="font-size:10px;color:var(--text-dim);margin-right:4px;"></span>
            <button class="icon-btn" style="width:20px;height:20px;font-size:10px;" onclick="openLibraryItemModal()" title="Add to Library">+</button>
            <button class="icon-btn" style="width:20px;height:20px;font-size:10px;" onclick="showLibrary()" title="Open Library">→</button>
          </div>
        </div>
        <div id="body-library"></div>
      </div>
    </div>
  </div>

  <!-- ══ MAIN ══ -->
  <div id="main">
    <!-- Toolbar -->
    <div id="editor-toolbar">
      <button class="icon-btn" onclick="toggleSidebar()" title="Toggle Sidebar" id="sidebar-toggle-btn">
        <svg viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M2 4h12M2 8h12M2 12h12"/></svg>
      </button>
      <div class="toolbar-sep"></div>
      <button class="toolbar-btn" id="btn-bold" onclick="insertMarkdown('bold')" title="Bold (Alt+B)"><b>B</b></button>
      <button class="toolbar-btn" id="btn-italic" onclick="insertMarkdown('italic')" title="Italic (Alt+I)"><i>I</i></button>
      <button class="toolbar-btn" onclick="insertMarkdown('h2')" title="Heading">H2</button>
      <button class="toolbar-btn" onclick="insertMarkdown('h3')" title="Heading 3">H3</button>
      <div class="toolbar-sep"></div>
      <button class="toolbar-btn" onclick="insertMarkdown('link')" title="Link">🔗</button>
      <button class="toolbar-btn" onclick="insertMarkdown('wikilink')" title="Wiki Link [[]]">[[]]</button>
      <button class="toolbar-btn" onclick="insertMarkdown('ul')" title="Bullet List">•</button>
      <button class="toolbar-btn" onclick="insertMarkdown('ol')" title="Numbered List">1.</button>
      <button class="toolbar-btn" onclick="insertMarkdown('checkbox')" title="Checkbox">☐</button>
      <button class="toolbar-btn" onclick="insertMarkdown('code')" title="Code Block">` `</button>
      <button class="toolbar-btn" onclick="insertMarkdown('quote')" title="Quote">"</button>
      <button class="toolbar-btn" onclick="insertMarkdown('hr')" title="Divider">—</button>
      <div class="toolbar-sep"></div>
      <button class="toolbar-btn" onclick="toggleCitationPanel()" title="Citation (Alt+C)">📖</button>
      <div class="toolbar-sep"></div>
      <div id="toolbar-title-area">
        <span id="note-title-display"></span>
      </div>
      <div id="toolbar-right">
        <button class="toolbar-btn" id="btn-view-edit" onclick="setViewMode('edit')" title="Edit Only">✏️</button>
        <button class="toolbar-btn" id="btn-view-split" onclick="setViewMode('split')" title="Split View">⊟</button>
        <button class="toolbar-btn" id="btn-view-preview" onclick="setViewMode('preview')" title="Preview Only">👁</button>
        <div class="toolbar-sep"></div>
        <button class="toolbar-btn" onclick="showGraphView()" title="Graph (Alt+G)">⬡</button>
        <button class="toolbar-btn" onclick="openCommandPalette()" title="Commands (Alt+K)">⌘</button>
        <button class="toolbar-btn" onclick="openSettings()" title="Settings">⚙</button>
        <div class="toolbar-sep"></div>
        <button class="toolbar-btn" onclick="exportNote('md')" title="Export Markdown">↓MD</button>
        <button class="toolbar-btn" onclick="exportNote('docx')" title="Export Word">↓DOC</button>
        <button class="toolbar-btn" onclick="toggleOutline()" title="Toggle Outline">≡</button>
        <button class="toolbar-btn" onclick="openHelp()" title="Keyboard Shortcuts &amp; Help (Alt+?)">?</button>
      </div>
    </div>

    <!-- Editor + Outline -->
    <div style="flex:1;display:flex;overflow:hidden;min-height:0;">
      <div id="editor-container">
        <!-- Empty state -->
        <div id="empty-state">
          <h2>Begin your knowledge graph</h2>
          <p>Create a note or open an existing one to start writing.</p>
          <div class="shortcut-table" style="margin-top:12px;">
            <div class="shortcut-row"><span>New note</span><kbd>Alt+N</kbd></div>
            <div class="shortcut-row"><span>Command palette</span><kbd>Alt+K</kbd></div>
            <div class="shortcut-row"><span>Daily note</span><kbd>Alt+D</kbd></div>
            <div class="shortcut-row"><span>Graph view</span><kbd>Alt+G</kbd></div>
            <div class="shortcut-row"><span>Global search</span><kbd>Alt+F</kbd></div>
            <div class="shortcut-row"><span>Star current note</span><kbd>Alt+*</kbd></div>
          </div>
          <button onclick="createNote()" style="margin-top:20px;padding:10px 24px;background:var(--accent);border:none;color:#0e0e0f;border-radius:6px;font-family:var(--ui-font);font-size:13px;font-weight:600;cursor:pointer;" onmouseover="this.style.background='var(--accent-hover)'" onmouseout="this.style.background='var(--accent)'">Create First Note</button>
        </div>

        <!-- Note editor (hidden until note selected) -->
        <div id="note-editor-wrapper" class="hidden" style="flex:1;display:flex;flex-direction:column;overflow:hidden;min-height:0;">
          <input id="note-title-input" placeholder="Untitled" oninput="onTitleChange(this.value)" />
          <div id="note-meta-bar">
            <div class="meta-item">
              <span style="color:var(--text-dim);">Type:</span>
              <select id="note-type-select" onchange="onTypeChange(this.value)">
                <option value="fleeting">Fleeting</option>
                <option value="literature">Literature</option>
                <option value="permanent">Permanent</option>
              </select>
            </div>
            <div class="meta-item">
              <span style="color:var(--text-dim);">Folder:</span>
              <select id="note-folder-select" onchange="onFolderChange(this.value)">
                <option value="">Root</option>
              </select>
            </div>
            <div id="note-tags-display" class="meta-item" style="flex-wrap:wrap;gap:4px;"></div>
            <div class="meta-item" style="margin-left:auto;">
              <span id="note-modified-display" style="color:var(--text-dim);font-size:11px;"></span>
            </div>
          </div>

          <!-- find bar -->
          <div id="find-bar">
            <input id="find-input" placeholder="Find in note…" oninput="findInNote(this.value)" />
            <span id="find-count"></span>
            <button class="icon-btn" style="width:22px;height:22px;" onclick="closeFindBar()">✕</button>
          </div>

          <!-- split editor/preview -->
          <div id="editor-split">
            <div id="editor-pane">
              <textarea id="markdown-editor" spellcheck="true" placeholder="Start writing… use [[Note Title]] to link notes, #tags to tag, and --- for frontmatter" oninput="onEditorChange(this.value)"></textarea>
            </div>
            <div id="split-drag-handle" title="Drag to resize"></div>
            <div id="preview-pane" class="hidden">
              <div id="preview-content" class="prose"></div>
            </div>
          </div>

          <!-- Citation panel -->
          <div id="citation-panel">
            <div id="citation-header" onclick="toggleCitationExpanded()">
              <div id="citation-header-left">
                <span id="citation-toggle-icon">▶</span>
                <span id="citation-title-text">Source / Citation</span>
              </div>
              <span style="font-size:11px;color:var(--text-dim);" id="citation-type-display"></span>
            </div>
            <div id="citation-body">
              <div class="citation-grid">
                <div>
                  <div class="citation-label">Source Type</div>
                  <select class="citation-select" id="cite-type" onchange="onCiteFieldChange()">
                    <option value="book">Book</option>
                    <option value="journal">Journal Article</option>
                    <option value="website">Website</option>
                    <option value="film">Film</option>
                    <option value="interview">Interview</option>
                    <option value="lecture">Lecture / Speech</option>
                    <option value="podcast">Podcast</option>
                    <option value="other">Other</option>
                  </select>
                </div>
                <div>
                  <div class="citation-label">Author(s) — Last, First</div>
                  <input class="citation-input" id="cite-authors" placeholder="Smith, John, and Doe, Jane" oninput="onCiteFieldChange()">
                </div>
                <div>
                  <div class="citation-label">Title of Source</div>
                  <input class="citation-input" id="cite-source-title" placeholder="Article or chapter title" oninput="onCiteFieldChange()">
                </div>
                <div>
                  <div class="citation-label">Container Title</div>
                  <input class="citation-input" id="cite-container" placeholder="Journal, website, anthology…" oninput="onCiteFieldChange()">
                </div>
                <div>
                  <div class="citation-label">Other Contributors</div>
                  <input class="citation-input" id="cite-contributors" placeholder="edited by John Smith" oninput="onCiteFieldChange()">
                </div>
                <div>
                  <div class="citation-label">Version / Edition</div>
                  <input class="citation-input" id="cite-version" placeholder="3rd ed." oninput="onCiteFieldChange()">
                </div>
                <div>
                  <div class="citation-label">Number</div>
                  <input class="citation-input" id="cite-number" placeholder="vol. 12, no. 4" oninput="onCiteFieldChange()">
                </div>
                <div>
                  <div class="citation-label">Publisher</div>
                  <input class="citation-input" id="cite-publisher" placeholder="Publisher name" oninput="onCiteFieldChange()">
                </div>
                <div>
                  <div class="citation-label">Publication Date</div>
                  <input class="citation-input" id="cite-pub-date" placeholder="2024, Jan. 2024, 15 Jan. 2024" oninput="onCiteFieldChange()">
                </div>
                <div>
                  <div class="citation-label">Location (pages/URL/DOI)</div>
                  <input class="citation-input" id="cite-location" placeholder="pp. 45-67 or URL" oninput="onCiteFieldChange()">
                </div>
                <div class="citation-field-full">
                  <div class="citation-label">Date of Access (online sources)</div>
                  <input class="citation-input" id="cite-access-date" placeholder="17 Feb. 2026" oninput="onCiteFieldChange()">
                </div>
              </div>
              <div class="citation-actions" style="margin-bottom:10px;position:relative;display:flex;gap:6px;align-items:center;">
                <button class="citation-btn primary" onclick="generateCitation()">Generate Citation</button>
                <button class="cite-import-btn" onclick="toggleLibImportDropdown()" title="Fill fields from a Library item">🗂 From Library</button>
                <div id="lib-import-dropdown"></div>
              </div>
              <div id="citation-preview" style="display:none;"></div>
              <div class="citation-actions" id="citation-post-actions" style="display:none;">
                <button class="citation-btn" onclick="copyCitation()">Copy Citation</button>
                <button class="citation-btn" onclick="insertCitationInNote()">Append to Note</button>
                <button class="citation-btn" id="inline-cite-btn" onclick="insertInlineCitation()" title="Insert (Author, Year) inline at cursor">Insert Inline</button>
              </div>
            </div>
          </div>

          <!-- Backlinks -->
          <div id="backlinks-panel">
            <div id="backlinks-title">Backlinks</div>
            <div id="backlinks-list"></div>
          </div>
        </div>

        <!-- Status bar -->
        <div id="status-bar">
          <span class="status-item" id="word-count">0 words</span>
          <span class="status-item" id="char-count">0 chars</span>
          <span class="status-item" id="read-time">~0 min read</span>
          <span class="status-item" id="note-id-display"></span>
          <div id="save-indicator">
            <div class="save-dot" id="save-dot"></div>
            <span id="save-text">Saved</span>
          </div>
        </div>
      </div>

      <!-- Outline -->
      <div id="outline-panel">
        <div id="outline-header">
          <span>Outline</span>
          <button class="icon-btn" style="width:18px;height:18px;font-size:10px;" onclick="toggleOutline()">✕</button>
        </div>
        <div id="outline-list"></div>
      </div>
    </div>
  </div>
</div>

<!-- ══ LIBRARY VIEW ══ -->
<div id="library-view">
  <div id="library-header">
    <button class="icon-btn" onclick="hideLibrary()">✕</button>
    <span style="font-size:14px;font-weight:600;color:var(--text);">Library</span>
    <span id="lib-total-count" style="font-size:12px;color:var(--text-dim);margin-left:4px;"></span>
    <div style="margin-left:auto;display:flex;gap:8px;">
      <button class="toolbar-btn" onclick="openLibraryItemModal()" style="background:var(--accent);color:#0e0e0f;border-radius:6px;font-weight:600;">+ Add Item</button>
      <button class="toolbar-btn" onclick="exportLibraryExcel()">↓ Excel</button>
      <button class="toolbar-btn" onclick="exportLibraryJSON()">↓ JSON</button>
    </div>
  </div>
  <div id="library-body">
    <!-- Left filter sidebar -->
    <div id="library-sidebar">
      <div class="lib-filter-section">Media Type</div>
      <div class="lib-filter-item active" data-filter-type="all" onclick="setLibFilter('type','all',this)">
        <span>All Items</span><span class="lib-filter-count" id="lfc-all">0</span>
      </div>
      <div class="lib-filter-item" data-filter-type="book" onclick="setLibFilter('type','book',this)">
        <span>📘 Books</span><span class="lib-filter-count" id="lfc-book">0</span>
      </div>
      <div class="lib-filter-item" data-filter-type="article" onclick="setLibFilter('type','article',this)">
        <span>📄 Articles</span><span class="lib-filter-count" id="lfc-article">0</span>
      </div>
      <div class="lib-filter-item" data-filter-type="film" onclick="setLibFilter('type','film',this)">
        <span>🎬 Films</span><span class="lib-filter-count" id="lfc-film">0</span>
      </div>
      <div class="lib-filter-item" data-filter-type="podcast" onclick="setLibFilter('type','podcast',this)">
        <span>🎙 Podcasts</span><span class="lib-filter-count" id="lfc-podcast">0</span>
      </div>
      <div class="lib-filter-item" data-filter-type="website" onclick="setLibFilter('type','website',this)">
        <span>🌐 Websites</span><span class="lib-filter-count" id="lfc-website">0</span>
      </div>
      <div class="lib-filter-item" data-filter-type="other" onclick="setLibFilter('type','other',this)">
        <span>📦 Other</span><span class="lib-filter-count" id="lfc-other">0</span>
      </div>
      <div class="lib-filter-section" style="margin-top:12px;">Reading Status</div>
      <div class="lib-filter-item" data-filter-status="all-status" onclick="setLibFilter('status','all',this)">
        <span>All</span>
      </div>
      <div class="lib-filter-item" data-filter-status="want" onclick="setLibFilter('status','want',this)">
        <span>📋 Want to Read</span>
      </div>
      <div class="lib-filter-item" data-filter-status="reading" onclick="setLibFilter('status','reading',this)">
        <span>📖 Reading</span>
      </div>
      <div class="lib-filter-item" data-filter-status="read" onclick="setLibFilter('status','read',this)">
        <span>✅ Read / Watched</span>
      </div>
      <div class="lib-filter-item" data-filter-status="abandoned" onclick="setLibFilter('status','abandoned',this)">
        <span>🗑 Abandoned</span>
      </div>
      <div class="lib-filter-section" style="margin-top:12px;">Linked</div>
      <div class="lib-filter-item" onclick="setLibFilter('linked','yes',this)">
        <span>🔗 Has Notes</span>
      </div>
      <div class="lib-filter-item" onclick="setLibFilter('linked','no',this)">
        <span>○ No Notes</span>
      </div>
    </div>

    <!-- Main content -->
    <div id="library-main">
      <div id="library-toolbar">
        <input id="lib-search-input" placeholder="Search library…" oninput="renderLibraryGrid()">
        <select id="lib-sort-select" onchange="renderLibraryGrid()">
          <option value="added-desc">Date Added ↓</option>
          <option value="added-asc">Date Added ↑</option>
          <option value="title-asc">Title A–Z</option>
          <option value="title-desc">Title Z–A</option>
          <option value="author-asc">Author A–Z</option>
          <option value="year-desc">Year ↓</option>
          <option value="rating-desc">Rating ↓</option>
        </select>
        <div class="lib-view-toggle">
          <button class="toolbar-btn active" id="lib-btn-grid" onclick="setLibViewMode('grid')" title="Grid View">⊞</button>
          <button class="toolbar-btn" id="lib-btn-list" onclick="setLibViewMode('list')" title="List View">☰</button>
        </div>
      </div>
      <div id="library-grid">
        <div id="lib-empty" class="hidden">
          <h3>Your library is empty</h3>
          <p style="font-size:13px;margin-bottom:16px;">Add books, articles, films, and other media to track your reading and research.</p>
          <button onclick="openLibraryItemModal()" style="padding:9px 20px;background:var(--accent);border:none;color:#0e0e0f;border-radius:6px;font-family:var(--ui-font);font-size:13px;font-weight:600;cursor:pointer;">Add First Item</button>
        </div>
        <div id="lib-items-container"></div>
      </div>
    </div>
  </div>
</div>

<!-- ══ LIBRARY ITEM MODAL ══ -->
<div id="lib-item-modal" onclick="if(event.target===this)closeLibraryModal()">
  <div id="lib-item-inner">
    <div id="lib-item-header">
      <span id="lib-item-title-text">Add to Library</span>
      <button class="icon-btn" onclick="closeLibraryModal()">✕</button>
    </div>
    <div id="lib-item-body">
      <div class="lib-form-grid">
        <!-- Type -->
        <div>
          <div class="lib-form-label">Media Type *</div>
          <select class="lib-form-select" id="lib-f-type" onchange="updateLibFormByType()">
            <option value="book">📘 Book</option>
            <option value="article">📄 Article / Paper</option>
            <option value="film">🎬 Film / Documentary</option>
            <option value="podcast">🎙 Podcast</option>
            <option value="website">🌐 Website / Blog</option>
            <option value="other">📦 Other</option>
          </select>
        </div>
        <!-- Status -->
        <div>
          <div class="lib-form-label">Status</div>
          <select class="lib-form-select" id="lib-f-status">
            <option value="want">📋 Want to Read</option>
            <option value="reading">📖 Currently Reading</option>
            <option value="read">✅ Read / Watched</option>
            <option value="abandoned">🗑 Abandoned</option>
          </select>
        </div>
        <!-- Title -->
        <div class="lib-form-full">
          <div class="lib-form-label">Title *</div>
          <input class="lib-form-input" id="lib-f-title" placeholder="Title of the work">
        </div>
        <!-- Author -->
        <div>
          <div class="lib-form-label" id="lib-label-author">Author(s)</div>
          <input class="lib-form-input" id="lib-f-author" placeholder="Last, First or Director">
        </div>
        <!-- Year -->
        <div>
          <div class="lib-form-label">Year</div>
          <input class="lib-form-input" id="lib-f-year" placeholder="2024" maxlength="4">
        </div>
        <!-- ISBN (books only) -->
        <div class="lib-form-full" id="lib-isbn-row">
          <div class="lib-form-label">ISBN / ISSN</div>
          <div class="isbn-row">
            <input class="lib-form-input" id="lib-f-isbn" placeholder="978-0-000-00000-0" style="flex:1;">
            <button class="isbn-lookup-btn" onclick="isbnLookup()">🔍 Auto-fill</button>
            <a id="lib-openlibrary-link" class="isbn-openlibrary-btn" href="#" target="_blank" title="View on Open Library">
              <span>📖</span> Open Library
            </a>
          </div>
          <div id="isbn-lookup-result"></div>
        </div>
        <!-- Publisher / Source -->
        <div>
          <div class="lib-form-label" id="lib-label-publisher">Publisher</div>
          <input class="lib-form-input" id="lib-f-publisher" placeholder="Publisher name">
        </div>
        <!-- Genre / Subject -->
        <div>
          <div class="lib-form-label">Genre / Subject</div>
          <input class="lib-form-input" id="lib-f-genre" placeholder="e.g. Philosophy, Science Fiction">
        </div>
        <!-- URL -->
        <div class="lib-form-full">
          <div class="lib-form-label" id="lib-label-url">URL / DOI</div>
          <input class="lib-form-input" id="lib-f-url" placeholder="https://" type="url">
        </div>
        <!-- Cover Image URL -->
        <div class="lib-form-full">
          <div class="lib-form-label">Cover Image URL (optional)</div>
          <input class="lib-form-input" id="lib-f-cover" placeholder="https://…/cover.jpg">
        </div>
        <!-- Rating -->
        <div>
          <div class="lib-form-label">Rating</div>
          <div class="lib-rating-input" id="lib-rating-stars">
            <button class="lib-star-btn" data-val="1" onclick="setLibRating(1)">★</button>
            <button class="lib-star-btn" data-val="2" onclick="setLibRating(2)">★</button>
            <button class="lib-star-btn" data-val="3" onclick="setLibRating(3)">★</button>
            <button class="lib-star-btn" data-val="4" onclick="setLibRating(4)">★</button>
            <button class="lib-star-btn" data-val="5" onclick="setLibRating(5)">★</button>
            <span id="lib-rating-display" style="font-size:11px;color:var(--text-dim);margin-left:6px;"></span>
          </div>
        </div>
        <!-- Tags -->
        <div>
          <div class="lib-form-label">Tags</div>
          <input class="lib-form-input" id="lib-f-tags" placeholder="#fiction #history (space-separated)">
        </div>
        <!-- Notes -->
        <div class="lib-form-full">
          <div class="lib-form-label">Personal Notes / Summary</div>
          <textarea class="lib-form-textarea" id="lib-f-notes" placeholder="Your thoughts, key takeaways, or a brief summary…" rows="4"></textarea>
        </div>
      </div>

      <!-- Linked Notes Section -->
      <div id="lib-linked-notes-section">
        <div class="lib-linked-notes-title">Linked Zettelkasten Notes</div>
        <div id="lib-linked-notes-list"></div>
        <div id="lib-note-search-row">
          <div style="position:relative;flex:1;">
            <input id="lib-note-search" placeholder="Search and link a note…" oninput="searchNotesForLink(this.value)" autocomplete="off">
            <div id="lib-note-search-results"></div>
          </div>
        </div>
      </div>
    </div>
    <div class="lib-item-footer">
      <button class="lib-delete-btn" id="lib-delete-btn" onclick="deleteLibraryItem()" style="display:none;">Delete</button>
      <div style="display:flex;gap:8px;margin-left:auto;">
        <button class="lib-delete-btn" onclick="closeLibraryModal()">Cancel</button>
        <button class="lib-save-btn" onclick="saveLibraryItem()">Save</button>
      </div>
    </div>
  </div>
</div>

<!-- ══ GRAPH VIEW ══ -->
<div id="graph-view">
  <div id="graph-header">
    <button class="icon-btn" onclick="hideGraphView()">✕</button>
    <span id="graph-title">Knowledge Graph</span>
    <span style="font-size:12px;color:var(--text-dim);margin-left:8px;" id="graph-stats"></span>
    <div style="margin-left:auto;display:flex;gap:8px;align-items:center;">
      <span style="font-size:11px;color:var(--text-dim);">Filter tag:</span>
      <select id="graph-tag-filter" onchange="renderGraph()">
        <option value="">All tags</option>
      </select>
      <span style="font-size:11px;color:var(--text-dim);">Color by:</span>
      <select id="graph-color-mode" onchange="renderGraph()" style="background:var(--panel-bg);border:1px solid var(--border);color:var(--text);padding:3px 6px;border-radius:4px;font-size:11px;font-family:var(--ui-font);outline:none;">
        <option value="type">Note Type</option>
        <option value="folder">Folder</option>
        <option value="tags">Tags</option>
      </select>
    </div>
  </div>
  <div id="graph-container"><svg id="graph-svg"></svg></div>
</div>
<div id="graph-hover-card">
  <div class="ghc-title" id="ghc-title"></div>
  <div class="ghc-meta" id="ghc-meta"></div>
  <div class="ghc-excerpt" id="ghc-excerpt"></div>
  <div class="ghc-hint">Click to open · Double-click to close graph</div>
</div>

<!-- ══ BIBLIOGRAPHY VIEW ══ -->
<div id="bibliography-view">
  <div id="bibliography-header">
    <button class="icon-btn" onclick="hideBibliography()">✕</button>
    <span style="font-size:14px;font-weight:600;color:var(--text);">Works Cited</span>
    <div style="margin-left:auto;display:flex;gap:8px;">
      <button class="toolbar-btn" onclick="copyBibliography()">Copy All</button>
      <button class="toolbar-btn" onclick="exportBibliography()">Export Word</button>
    </div>
  </div>
  <div id="bibliography-content">
    <div id="bibliography-title">Works Cited</div>
    <div id="bibliography-entries"></div>
  </div>
</div>

<!-- ══ COMMAND PALETTE ══ -->
<div id="cmd-palette" onclick="if(event.target===this)closeCommandPalette()">
  <div id="cmd-palette-inner">
    <input id="cmd-input" placeholder="Search commands and notes…" oninput="filterCommands(this.value)" onkeydown="cmdKeyDown(event)" autocomplete="off">
    <div id="cmd-results"></div>
  </div>
</div>

<!-- ══ GLOBAL SEARCH ══ -->
<div id="search-panel" onclick="if(event.target===this)closeSearch()">
  <div id="search-inner">
    <div id="search-input-wrap">
      <svg width="16" height="16" viewBox="0 0 16 16" fill="none" stroke="var(--text-dim)" stroke-width="2"><circle cx="7" cy="7" r="4"/><path d="M11 11l3 3" stroke-linecap="round"/></svg>
      <input id="global-search-input" placeholder="Search all notes…" oninput="globalSearch(this.value)" onkeydown="if(event.key==='Escape')closeSearch()">
      <button class="icon-btn" onclick="closeSearch()">✕</button>
    </div>
    <div id="search-filters">
      <button class="search-filter-btn active" data-type="all" onclick="setSearchFilter('all',this)">All</button>
      <button class="search-filter-btn" data-type="fleeting" onclick="setSearchFilter('fleeting',this)">🟠 Fleeting</button>
      <button class="search-filter-btn" data-type="literature" onclick="setSearchFilter('literature',this)">🔵 Literature</button>
      <button class="search-filter-btn" data-type="permanent" onclick="setSearchFilter('permanent',this)">🟢 Permanent</button>
      <button class="search-filter-btn" data-type="starred" onclick="setSearchFilter('starred',this)">⭐ Starred</button>
    </div>
    <div id="search-stats"></div>
    <div id="search-results"></div>
  </div>
</div>

<!-- ══ SETTINGS ══ -->
<div id="settings-modal" onclick="if(event.target===this)closeSettings()">
  <div id="settings-inner">
    <div id="settings-header">
      <span id="settings-title">Settings</span>
      <button class="icon-btn" onclick="closeSettings()">✕</button>
    </div>
    <div id="settings-body">
      <div class="settings-section">
        <div class="settings-section-title">Appearance</div>
        <div class="settings-row">
          <div><div class="settings-label">Theme</div></div>
          <div class="settings-control">
            <select id="setting-theme" onchange="applySettings()">
              <option value="dark">Dark</option>
              <option value="light">Light</option>
            </select>
          </div>
        </div>
        <div class="settings-row">
          <div><div class="settings-label">Editor Font</div></div>
          <div class="settings-control">
            <select id="setting-editor-font" onchange="applySettings()">
              <option value="mono">JetBrains Mono</option>
              <option value="sans">Sora (sans-serif)</option>
              <option value="serif">Crimson Pro (serif)</option>
            </select>
          </div>
        </div>
        <div class="settings-row">
          <div><div class="settings-label">Editor Font Size</div></div>
          <div class="settings-control">
            <input type="number" id="setting-font-size" value="14" min="10" max="22" style="width:60px;" onchange="applySettings()">
          </div>
        </div>
      </div>
      <div class="settings-section">
        <div class="settings-section-title">Editor</div>
        <div class="settings-row">
          <div><div class="settings-label">Default View Mode</div></div>
          <div class="settings-control">
            <select id="setting-view-mode" onchange="applySettings()">
              <option value="split">Split</option>
              <option value="edit">Edit Only</option>
              <option value="preview">Preview Only</option>
            </select>
          </div>
        </div>
        <div class="settings-row">
          <div><div class="settings-label">Default Note Type</div></div>
          <div class="settings-control">
            <select id="setting-default-type" onchange="applySettings()">
              <option value="fleeting">Fleeting</option>
              <option value="literature">Literature</option>
              <option value="permanent">Permanent</option>
            </select>
          </div>
        </div>
        <div class="settings-row">
          <div><div class="settings-label">Default Citation Type</div></div>
          <div class="settings-control">
            <select id="setting-default-cite-type" onchange="applySettings()">
              <option value="book">Book</option>
              <option value="journal">Journal Article</option>
              <option value="website">Website</option>
              <option value="film">Film</option>
              <option value="interview">Interview</option>
              <option value="lecture">Lecture</option>
              <option value="podcast">Podcast</option>
            </select>
          </div>
        </div>
      </div>
      <div class="settings-section">
        <div class="settings-section-title">Daily Note Template</div>
        <div class="settings-control" style="width:100%;">
          <textarea id="setting-daily-template" style="width:100%;" placeholder="# {{date}}&#10;&#10;## Today's focus&#10;&#10;## Notes&#10;&#10;## Gratitude"></textarea>
        </div>
      </div>
      <div class="settings-section">
        <div class="settings-section-title">Data</div>
        <div class="settings-row">
          <div><div class="settings-label">Export All Notes (JSON)</div></div>
          <div class="settings-control">
            <button class="citation-btn" onclick="exportAllJSON()">Export JSON</button>
          </div>
        </div>
        <div class="settings-row">
          <div><div class="settings-label">Import Notes (JSON)</div></div>
          <div class="settings-control">
            <button class="citation-btn" onclick="document.getElementById('import-file').click()">Import JSON</button>
            <input type="file" id="import-file" accept=".json" style="display:none" onchange="importJSON(this)">
          </div>
        </div>
        <div class="settings-row">
          <div><div class="settings-label">Export Metadata (Excel)</div></div>
          <div class="settings-control">
            <button class="citation-btn" onclick="exportExcel()">Export XLSX</button>
          </div>
        </div>
        <div class="settings-row" style="border-top:1px solid var(--red);padding-top:12px;">
          <div><div class="settings-label" style="color:var(--red);">Delete All Notes</div></div>
          <div class="settings-control">
            <button class="citation-btn" style="border-color:var(--red);color:var(--red);" onclick="confirmDeleteAll()">Delete All</button>
          </div>
        </div>
      </div>
      <div class="settings-section">
        <div class="settings-section-title">Keyboard Shortcuts</div>
        <div style="font-size:12px;color:var(--text-muted);">
          <div class="shortcut-row"><span>New note</span><kbd>Alt+N</kbd></div>
          <div class="shortcut-row"><span>Command palette</span><kbd>Alt+K</kbd></div>
          <div class="shortcut-row"><span>Daily note</span><kbd>Alt+D</kbd></div>
          <div class="shortcut-row"><span>Graph view</span><kbd>Alt+G</kbd></div>
          <div class="shortcut-row"><span>Global search</span><kbd>Alt+F</kbd></div>
          <div class="shortcut-row"><span>Find in note</span><kbd>Alt+/</kbd></div>
          <div class="shortcut-row"><span>Toggle edit/preview</span><kbd>Alt+E</kbd></div>
          <div class="shortcut-row"><span>Bold</span><kbd>Alt+B</kbd></div>
          <div class="shortcut-row"><span>Italic</span><kbd>Alt+I</kbd></div>
          <div class="shortcut-row"><span>Citation panel</span><kbd>Alt+C</kbd></div>
          <div class="shortcut-row"><span>Force save</span><kbd>Alt+S</kbd></div>
          <div class="shortcut-row"><span>Split view</span><kbd>Alt+\\</kbd></div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- ══ TOAST ══ -->
<!-- ══ HELP MODAL ══ -->
<div id="help-modal" onclick="if(event.target===this)closeHelp()">
  <div id="help-inner">
    <div id="help-header">
      <div id="help-header-left">
        <div id="help-header-icon">?</div>
        <div>
          <div id="help-header-title">Keyboard Shortcuts &amp; Commands</div>
          <div id="help-header-sub">All shortcuts use the <strong style="color:var(--accent)">Alt</strong> key</div>
        </div>
      </div>
      <button class="icon-btn" onclick="closeHelp()">✕</button>
    </div>
    <div id="help-body">

      <div class="help-section">
        <div class="help-section-title">Notes</div>
        <div class="help-grid">
          <div class="help-row"><span class="help-label">New Note</span><span class="help-keys"><span class="help-key accent">Alt</span><span class="help-plus">+</span><span class="help-key">N</span></span></div>
          <div class="help-row"><span class="help-label">Open Daily Note</span><span class="help-keys"><span class="help-key accent">Alt</span><span class="help-plus">+</span><span class="help-key">D</span></span></div>
          <div class="help-row"><span class="help-label">Star / Unstar Note</span><span class="help-keys"><span class="help-key accent">Alt</span><span class="help-plus">+</span><span class="help-key">*</span></span></div>
          <div class="help-row"><span class="help-label">Force Save</span><span class="help-keys"><span class="help-key accent">Alt</span><span class="help-plus">+</span><span class="help-key">S</span></span></div>
        </div>
      </div>

      <div class="help-section">
        <div class="help-section-title">Navigation</div>
        <div class="help-grid">
          <div class="help-row"><span class="help-label">Command Palette</span><span class="help-keys"><span class="help-key accent">Alt</span><span class="help-plus">+</span><span class="help-key">K</span></span></div>
          <div class="help-row"><span class="help-label">Global Search</span><span class="help-keys"><span class="help-key accent">Alt</span><span class="help-plus">+</span><span class="help-key">F</span></span></div>
          <div class="help-row"><span class="help-label">Graph View</span><span class="help-keys"><span class="help-key accent">Alt</span><span class="help-plus">+</span><span class="help-key">G</span></span></div>
          <div class="help-row"><span class="help-label">Find in Note</span><span class="help-keys"><span class="help-key accent">Alt</span><span class="help-plus">+</span><span class="help-key">/</span></span></div>
        </div>
      </div>

      <div class="help-section">
        <div class="help-section-title">Editor</div>
        <div class="help-grid">
          <div class="help-row"><span class="help-label">Bold</span><span class="help-keys"><span class="help-key accent">Alt</span><span class="help-plus">+</span><span class="help-key">B</span></span></div>
          <div class="help-row"><span class="help-label">Italic</span><span class="help-keys"><span class="help-key accent">Alt</span><span class="help-plus">+</span><span class="help-key">I</span></span></div>
          <div class="help-row"><span class="help-label">Citation Panel</span><span class="help-keys"><span class="help-key accent">Alt</span><span class="help-plus">+</span><span class="help-key">C</span></span></div>
          <div class="help-row"><span class="help-label">Toggle Edit / Preview</span><span class="help-keys"><span class="help-key accent">Alt</span><span class="help-plus">+</span><span class="help-key">E</span></span></div>
          <div class="help-row"><span class="help-label">Split View</span><span class="help-keys"><span class="help-key accent">Alt</span><span class="help-plus">+</span><span class="help-key">\</span></span></div>
          <div class="help-row"><span class="help-label">This Help Menu</span><span class="help-keys"><span class="help-key accent">Alt</span><span class="help-plus">+</span><span class="help-key">?</span></span></div>
        </div>
      </div>

      <div class="help-section">
        <div class="help-section-title">Markdown Syntax</div>
        <div class="help-grid">
          <div class="help-row"><span class="help-label">Link to a note</span><span class="help-keys"><span class="help-key">[[Note Title]]</span></span></div>
          <div class="help-row"><span class="help-label">Add a tag</span><span class="help-keys"><span class="help-key">#tagname</span></span></div>
          <div class="help-row"><span class="help-label">Heading</span><span class="help-keys"><span class="help-key">## Heading</span></span></div>
          <div class="help-row"><span class="help-label">Bold</span><span class="help-keys"><span class="help-key">**text**</span></span></div>
          <div class="help-row"><span class="help-label">Italic</span><span class="help-keys"><span class="help-key">*text*</span></span></div>
          <div class="help-row"><span class="help-label">Checkbox</span><span class="help-keys"><span class="help-key">- [ ] task</span></span></div>
          <div class="help-row"><span class="help-label">Blockquote</span><span class="help-keys"><span class="help-key">> text</span></span></div>
          <div class="help-row"><span class="help-label">Code block</span><span class="help-keys"><span class="help-key">``` code ```</span></span></div>
          <div class="help-row"><span class="help-label">Divider</span><span class="help-keys"><span class="help-key">---</span></span></div>
          <div class="help-row"><span class="help-label">External link</span><span class="help-keys"><span class="help-key">[text](url)</span></span></div>
        </div>
      </div>

      <div class="help-section">
        <div class="help-section-title">Features</div>
        <div class="help-grid">
          <div class="help-row"><span class="help-label">🟠 Fleeting note</span><span class="help-label" style="color:var(--text-dim);font-size:11px;">Quick ideas &amp; captures</span></div>
          <div class="help-row"><span class="help-label">🔵 Literature note</span><span class="help-label" style="color:var(--text-dim);font-size:11px;">Notes from sources</span></div>
          <div class="help-row"><span class="help-label">🟢 Permanent note</span><span class="help-label" style="color:var(--text-dim);font-size:11px;">Refined, atomic ideas</span></div>
          <div class="help-row"><span class="help-label">📚 Bibliography</span><span class="help-label" style="color:var(--text-dim);font-size:11px;">Auto MLA citations</span></div>
          <div class="help-row"><span class="help-label">🗂 Library</span><span class="help-label" style="color:var(--text-dim);font-size:11px;">Track books &amp; media</span></div>
          <div class="help-row"><span class="help-label">⬡ Graph View</span><span class="help-label" style="color:var(--text-dim);font-size:11px;">Visual knowledge map</span></div>
          <div class="help-row"><span class="help-label">⭐ Starred Notes</span><span class="help-label" style="color:var(--text-dim);font-size:11px;">Pin important notes</span></div>
          <div class="help-row"><span class="help-label">📅 Daily Notes</span><span class="help-label" style="color:var(--text-dim);font-size:11px;">Journal by date</span></div>
        </div>
      </div>

    </div>
    <div class="help-footer">
      <div class="help-footer-tip">💡 Tip: Open the <strong style="color:var(--accent)">Command Palette</strong> (Alt+K) to search all commands and notes</div>
      <button class="help-close-btn" onclick="closeHelp()">Done</button>
    </div>
  </div>
</div>

<div id="toast-container"></div>

<!-- ══ BACKUP BANNER ══ -->
<div id="backup-banner">
  <span>💾</span>
  <span style="color:var(--text);">You have <strong id="backup-note-count"></strong> notes — consider exporting a backup occasionally.</span>
  <button onclick="exportAllJSON(); dismissBackupBanner()" style="padding:5px 12px;background:var(--accent);border:none;color:#0e0e0f;border-radius:5px;font-family:var(--ui-font);font-size:12px;cursor:pointer;margin-left:8px;">Export Now</button>
  <button onclick="dismissBackupBanner()" class="backup-close" title="Dismiss">✕</button>
</div>

<script>
// ════════════════════════════════════════════════
//  DATA LAYER
// ════════════════════════════════════════════════

const STORAGE_KEYS = { NOTES: 'zk_notes', SETTINGS: 'zk_settings', RECENT: 'zk_recent', FOLDERS: 'zk_folders', LIBRARY: 'zk_library' };

let notes = {};       // { id: noteObj }
let settings = {};
let recentNotes = []; // array of ids
let folders = [];     // array of folder paths
let library = {};     // { id: libraryItem }
let currentNoteId = null;
let saveTimer = null;
let calendarDate = new Date();

const DEFAULT_SETTINGS = {
  theme: 'dark',
  editorFont: 'mono',
  fontSize: 14,
  viewMode: 'split',
  defaultType: 'fleeting',
  defaultCiteType: 'book',
  dailyTemplate: '# {{date}}\n\n## Focus\n\n## Notes\n\n## Reflections\n'
};

function genId() {
  return Date.now().toString(36) + Math.random().toString(36).slice(2, 7);
}

function load() {
  try { notes = JSON.parse(localStorage.getItem(STORAGE_KEYS.NOTES) || '{}'); } catch { notes = {}; }
  try { settings = { ...DEFAULT_SETTINGS, ...JSON.parse(localStorage.getItem(STORAGE_KEYS.SETTINGS) || '{}') }; } catch { settings = { ...DEFAULT_SETTINGS }; }
  try { recentNotes = JSON.parse(localStorage.getItem(STORAGE_KEYS.RECENT) || '[]'); } catch { recentNotes = []; }
  try { folders = JSON.parse(localStorage.getItem(STORAGE_KEYS.FOLDERS) || '[]'); } catch { folders = []; }
  try { library = JSON.parse(localStorage.getItem(STORAGE_KEYS.LIBRARY) || '{}'); } catch { library = {}; }
}

function saveStorage() {
  localStorage.setItem(STORAGE_KEYS.NOTES, JSON.stringify(notes));
  localStorage.setItem(STORAGE_KEYS.SETTINGS, JSON.stringify(settings));
  localStorage.setItem(STORAGE_KEYS.RECENT, JSON.stringify(recentNotes));
  localStorage.setItem(STORAGE_KEYS.FOLDERS, JSON.stringify(folders));
  localStorage.setItem(STORAGE_KEYS.LIBRARY, JSON.stringify(library));
}

function saveSettings() {
  localStorage.setItem(STORAGE_KEYS.SETTINGS, JSON.stringify(settings));
}

// ════════════════════════════════════════════════
//  NOTE OPERATIONS
// ════════════════════════════════════════════════

function createNote(opts = {}) {
  const id = genId();
  const type = opts.type || settings.defaultType || 'fleeting';
  const note = {
    id,
    title: opts.title || '',
    body: opts.body || '',
    folder: opts.folder || '',
    tags: [],
    type,
    starred: false,
    created: Date.now(),
    modified: Date.now(),
    citation: {
      expanded: type === 'literature',
      sourceType: settings.defaultCiteType || 'book',
      authors: '', sourcetitle: '', container: '', contributors: '',
      version: '', number: '', publisher: '', pubDate: '', location: '', accessDate: '',
      generated: ''
    }
  };
  notes[id] = note;
  saveStorage();
  renderSidebar();
  openNote(id);
  if (note.title === '') {
    setTimeout(() => {
      const ti = document.getElementById('note-title-input');
      if (ti) ti.focus();
    }, 50);
  }
  toast('New note created', 'success');
  return id;
}

function deleteNote(id) {
  if (!notes[id]) return;
  const title = notes[id].title || 'Untitled';
  if (!confirm(`Delete "${title}"?`)) return;
  delete notes[id];
  if (currentNoteId === id) { currentNoteId = null; showEmptyState(); }
  recentNotes = recentNotes.filter(r => r !== id);
  saveStorage();
  renderSidebar();
  toast(`Deleted "${title}"`, 'info');
}

function openNote(id) {
  if (!notes[id]) return;
  currentNoteId = id;
  addToRecent(id);
  renderNoteEditor(notes[id]);
  renderSidebar();
}

function addToRecent(id) {
  recentNotes = [id, ...recentNotes.filter(r => r !== id)].slice(0, 15);
  localStorage.setItem(STORAGE_KEYS.RECENT, JSON.stringify(recentNotes));
}

function toggleStar(id) {
  if (!notes[id]) return;
  notes[id].starred = !notes[id].starred;
  saveStorage();
  renderSidebar();
}

function duplicateNote(id) {
  if (!notes[id]) return;
  const orig = notes[id];
  const newId = createNote({ title: orig.title + ' (copy)', body: orig.body, folder: orig.folder, type: orig.type });
  toast('Note duplicated', 'success');
}

// parse tags from body text
function parseTags(body) {
  const matches = body.match(/#([\w/]+)/g) || [];
  return [...new Set(matches.map(t => t.slice(1)))];
}

// parse [[wikilinks]] from body
function parseWikiLinks(body) {
  const matches = body.match(/\[\[([^\]]+)\]\]/g) || [];
  return [...new Set(matches.map(m => m.slice(2, -2)))];
}

// find note by title (case insensitive)
function findNoteByTitle(title) {
  const t = title.toLowerCase().trim();
  return Object.values(notes).find(n => (n.title || '').toLowerCase().trim() === t);
}

// get backlinks for a note
function getBacklinks(id) {
  const note = notes[id];
  if (!note) return [];
  const links = parseWikiLinks(note.body || '');
  // who links TO this note?
  return Object.values(notes).filter(n => {
    if (n.id === id) return false;
    const outLinks = parseWikiLinks(n.body || '');
    return outLinks.some(l => l.toLowerCase() === (note.title || '').toLowerCase());
  });
}

function autoSave() {
  if (!currentNoteId || !notes[currentNoteId]) return;
  setSaveIndicator('saving');
  saveStorage();
  setSaveIndicator('saved');
}

function setSaveIndicator(state) {
  const dot = document.getElementById('save-dot');
  const txt = document.getElementById('save-text');
  if (!dot || !txt) return;
  if (state === 'unsaved') { dot.classList.add('unsaved'); txt.textContent = 'Unsaved'; }
  else if (state === 'saving') { dot.classList.remove('unsaved'); txt.textContent = 'Saving…'; }
  else { dot.classList.remove('unsaved'); txt.textContent = 'Saved'; }
}

// ════════════════════════════════════════════════
//  RENDER
// ════════════════════════════════════════════════

function showEmptyState() {
  document.getElementById('empty-state').classList.remove('hidden');
  document.getElementById('note-editor-wrapper').classList.add('hidden');
  document.getElementById('note-title-display').textContent = '';
}

function renderNoteEditor(note) {
  document.getElementById('empty-state').classList.add('hidden');
  const wrapper = document.getElementById('note-editor-wrapper');
  wrapper.classList.remove('hidden');
  wrapper.style.display = 'flex';

  document.getElementById('note-title-input').value = note.title || '';
  document.getElementById('note-title-display').textContent = note.title || 'Untitled';
  document.getElementById('markdown-editor').value = note.body || '';
  document.getElementById('note-type-select').value = note.type || 'fleeting';
  document.getElementById('note-modified-display').textContent = 'Modified: ' + formatDate(note.modified);
  document.getElementById('note-id-display').textContent = 'ID: ' + note.id;

  // folder select
  renderFolderSelect(note.folder);

  // tags
  renderTagsDisplay(note);

  // view mode
  setViewMode(settings.viewMode || 'split', false);

  // citation panel
  renderCitationPanel(note);

  // backlinks
  renderBacklinks(note);

  // outline
  renderOutline(note.body || '');

  // stats
  updateStats(note.body || '');
}

function renderFolderSelect(currentFolder) {
  const sel = document.getElementById('note-folder-select');
  sel.innerHTML = '<option value="">Root</option>';
  folders.forEach(f => {
    const opt = document.createElement('option');
    opt.value = f; opt.textContent = f;
    sel.appendChild(opt);
  });
  sel.value = currentFolder || '';
}

function renderTagsDisplay(note) {
  const tags = parseTags(note.body || '');
  const container = document.getElementById('note-tags-display');
  container.innerHTML = '';
  tags.forEach(tag => {
    const span = document.createElement('span');
    span.className = 'meta-tag';
    span.textContent = '#' + tag;
    span.onclick = () => filterByTag(tag);
    container.appendChild(span);
  });
}

function renderBacklinks(note) {
  const bls = getBacklinks(note.id);
  const list = document.getElementById('backlinks-list');
  const panel = document.getElementById('backlinks-panel');
  list.innerHTML = '';
  if (bls.length === 0) {
    list.innerHTML = '<div style="font-size:12px;color:var(--text-dim);">No backlinks</div>';
  } else {
    bls.forEach(bl => {
      const div = document.createElement('div');
      div.className = 'backlink-item';
      div.innerHTML = `<span style="font-size:12px;">📄</span>${bl.title || 'Untitled'}`;
      div.onclick = () => openNote(bl.id);
      list.appendChild(div);
    });
  }
}

function renderOutline(body) {
  const list = document.getElementById('outline-list');
  list.innerHTML = '';
  const lines = body.split('\n');
  lines.forEach((line, i) => {
    const m = line.match(/^(#{1,6})\s+(.+)/);
    if (m) {
      const level = m[1].length;
      const text = m[2];
      const div = document.createElement('div');
      div.className = `outline-item outline-h${level}`;
      div.textContent = text;
      div.onclick = () => scrollEditorToLine(i);
      list.appendChild(div);
    }
  });
}

function scrollEditorToLine(lineIdx) {
  const editor = document.getElementById('markdown-editor');
  const lines = editor.value.split('\n');
  let pos = 0;
  for (let i = 0; i < lineIdx; i++) pos += lines[i].length + 1;
  editor.focus();
  editor.setSelectionRange(pos, pos);
  // scroll to visible
  const lineHeight = parseInt(getComputedStyle(editor).lineHeight);
  editor.scrollTop = lineIdx * lineHeight - 100;
}

function updateStats(body) {
  const words = body.trim() ? body.trim().split(/\s+/).length : 0;
  const chars = body.length;
  const readMin = Math.max(1, Math.round(words / 200));
  document.getElementById('word-count').textContent = words + ' words';
  document.getElementById('char-count').textContent = chars + ' chars';
  document.getElementById('read-time').textContent = '~' + readMin + ' min read';
}

// ════════════════════════════════════════════════
//  MARKDOWN RENDERING
// ════════════════════════════════════════════════

function renderMarkdown(body) {
  // process [[wikilinks]] before marked
  const processed = body.replace(/\[\[([^\]]+)\]\]/g, (match, title) => {
    const found = findNoteByTitle(title);
    if (found) {
      return `<a class="wiki-link" data-note-id="${found.id}" onclick="openNote('${found.id}')">${title}</a>`;
    } else {
      return `<a class="wiki-link wiki-link-missing" onclick="promptCreateNote('${title.replace(/'/g,"\\'")}')">[[${title}]]</a>`;
    }
  });

  // configure marked
  marked.setOptions({ breaks: true, gfm: true });
  let html = marked.parse(processed);

  // highlight code blocks
  const tempDiv = document.createElement('div');
  tempDiv.innerHTML = html;
  tempDiv.querySelectorAll('pre code').forEach(block => {
    hljs.highlightElement(block);
  });
  return tempDiv.innerHTML;
}

function updatePreview() {
  const preview = document.getElementById('preview-content');
  if (!preview || preview.closest('#preview-pane').classList.contains('hidden')) return;
  const body = document.getElementById('markdown-editor').value;
  preview.innerHTML = renderMarkdown(body);
}

function promptCreateNote(title) {
  if (confirm(`Note "${title}" doesn't exist. Create it?`)) {
    createNote({ title });
  }
}

// ════════════════════════════════════════════════
//  SIDEBAR RENDER
// ════════════════════════════════════════════════

function renderSidebar() {
  renderStarred();
  renderFolderTree();
  renderTagsBrowser();
  renderRecentNotes();
  renderCalendar();
  renderLibrarySidebar();
}

function renderStarred() {
  const container = document.getElementById('body-starred');
  container.innerHTML = '';
  const starred = Object.values(notes).filter(n => n.starred);
  if (starred.length === 0) {
    container.innerHTML = '<div style="font-size:11.5px;color:var(--text-dim);padding:4px 14px;">No starred notes</div>';
    return;
  }
  starred.forEach(note => {
    container.appendChild(makeNoteItem(note));
  });
}

let _activeTagFilter = '';

function clearTagFilter() {
  _activeTagFilter = '';
  const atf = document.getElementById('active-tag-filter');
  if (atf) atf.classList.remove('visible');
  renderFolderTree();
}

function sortNotes(noteList) {
  const sortSelect = document.getElementById('notes-sort-select');
  const sort = sortSelect ? sortSelect.value : 'modified';
  const arr = [...noteList];
  switch (sort) {
    case 'created': return arr.sort((a, b) => b.created - a.created);
    case 'title': return arr.sort((a, b) => (a.title||'').localeCompare(b.title||''));
    case 'type': return arr.sort((a, b) => (a.type||'').localeCompare(b.type||''));
    default: return arr.sort((a, b) => b.modified - a.modified);
  }
}

function renderFolderTree() {
  const container = document.getElementById('body-folders');
  container.innerHTML = '';

  const atf = document.getElementById('active-tag-filter');
  const atfText = document.getElementById('active-tag-text');
  if (_activeTagFilter) {
    if (atf) atf.classList.add('visible');
    if (atfText) atfText.textContent = '#' + _activeTagFilter;
    const filtered = sortNotes(Object.values(notes).filter(n => (n.tags || []).includes(_activeTagFilter) || parseTags(n.body || '').includes(_activeTagFilter)));
    filtered.forEach(note => container.appendChild(makeNoteItem(note)));
    return;
  } else {
    if (atf) atf.classList.remove('visible');
  }

  const rootNotes = sortNotes(Object.values(notes).filter(n => !n.folder));
  rootNotes.forEach(note => container.appendChild(makeNoteItem(note)));

  const usedFolders = [...new Set(Object.values(notes).filter(n => n.folder).map(n => n.folder))];
  const allFolders = [...new Set([...folders, ...usedFolders])].sort();

  allFolders.forEach(folder => {
    const folderNotes = sortNotes(Object.values(notes).filter(n => n.folder === folder));
    const folderDiv = document.createElement('div');
    folderDiv.innerHTML = `
      <div class="folder-item" onclick="this.nextElementSibling.classList.toggle('collapsed');this.querySelector('.folder-toggle').classList.toggle('open')">
        <span class="folder-toggle">\u25B6</span>
        <span class="folder-icon">\uD83D\uDCC1</span>
        <span class="folder-label">${folder}</span>
        <span class="folder-count">${folderNotes.length}</span>
        <button class="note-action-btn" onclick="event.stopPropagation();deleteFolder('${folder}')" title="Delete folder" style="margin-left:4px;">\uD83D\uDDD1</button>
      </div>
      <div class="folder-children collapsed">
        ${folderNotes.map(n => makeNoteItemHTML(n, true)).join('')}
      </div>
    `;
    container.appendChild(folderDiv);
    const items = folderDiv.querySelectorAll('.note-item');
    items.forEach(item => {
      const nid = item.dataset.id;
      item.querySelector('.note-title').addEventListener('click', () => openNote(nid));
    });
  });
}

function makeNoteItemHTML(note, indent = false) {
  const active = currentNoteId === note.id ? 'active' : '';
  const typeClass = `type-${note.type}`;
  const starred = note.starred ? '⭐' : '';
  return `<div class="note-item ${active}" data-id="${note.id}" style="${indent?'padding-left:26px':''}">
    <span class="note-icon">${starred || '📄'}</span>
    <span class="note-title" onclick="openNote('${note.id}')">${note.title || 'Untitled'}</span>
    <span class="type-badge ${typeClass}">${note.type.slice(0,1).toUpperCase()}</span>
    <div class="note-actions">
      <button class="note-action-btn" onclick="event.stopPropagation();toggleStar('${note.id}')" title="Star">⭐</button>
      <button class="note-action-btn" onclick="event.stopPropagation();duplicateNote('${note.id}')" title="Duplicate">⎘</button>
      <button class="note-action-btn" onclick="event.stopPropagation();deleteNote('${note.id}')" title="Delete">🗑</button>
    </div>
  </div>`;
}

function makeNoteItem(note) {
  const div = document.createElement('div');
  div.innerHTML = makeNoteItemHTML(note);
  const item = div.firstElementChild;
  item.querySelector('.note-title').addEventListener('click', () => openNote(note.id));
  return item;
}

function renderTagsBrowser() {
  const container = document.getElementById('body-tags');
  container.innerHTML = '';
  const tagMap = {};
  Object.values(notes).forEach(n => {
    parseTags(n.body || '').forEach(tag => {
      tagMap[tag] = (tagMap[tag] || 0) + 1;
    });
  });
  const sortedTags = Object.entries(tagMap).sort((a, b) => b[1] - a[1]);
  if (sortedTags.length === 0) {
    container.innerHTML = '<div style="font-size:11.5px;color:var(--text-dim);padding:4px 14px;">No tags yet</div>';
    return;
  }
  sortedTags.forEach(([tag, count]) => {
    const div = document.createElement('div');
    div.className = 'tag-item';
    div.innerHTML = `<span class="tag-name"><span class="tag-dot"></span>#${tag}</span><span class="tag-count">${count}</span>`;
    div.onclick = () => filterByTag(tag);
    container.appendChild(div);
  });
}

function renderRecentNotes() {
  const container = document.getElementById('body-recent');
  container.innerHTML = '';
  const recent = recentNotes.filter(id => notes[id]).slice(0, 10);
  if (recent.length === 0) {
    container.innerHTML = '<div style="font-size:11.5px;color:var(--text-dim);padding:4px 14px;">No recent notes</div>';
    return;
  }
  recent.forEach(id => {
    container.appendChild(makeNoteItem(notes[id]));
  });
}

let _sidebarFilter = '';
function sidebarSearchFilter(q) {
  _sidebarFilter = q.toLowerCase();
  if (!q) { renderSidebar(); return; }
  // show filtered results in folders section
  const container = document.getElementById('body-folders');
  container.innerHTML = '';
  Object.values(notes).filter(n =>
    (n.title || '').toLowerCase().includes(_sidebarFilter) ||
    (n.body || '').toLowerCase().includes(_sidebarFilter)
  ).forEach(n => container.appendChild(makeNoteItem(n)));
}

function filterByTag(tag) {
  _activeTagFilter = tag;
  renderFolderTree();
  // Scroll sidebar to notes section
  document.getElementById('section-folders')?.scrollIntoView({ behavior: 'smooth', block: 'start' });
  toast('Filtering by #' + tag, 'info');
}

// ════════════════════════════════════════════════
//  CALENDAR
// ════════════════════════════════════════════════

function renderCalendar() {
  const container = document.getElementById('calendar-widget');
  const year = calendarDate.getFullYear();
  const month = calendarDate.getMonth();
  const monthNames = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
  const dayNames = ['Su','Mo','Tu','We','Th','Fr','Sa'];
  const today = new Date();

  const firstDay = new Date(year, month, 1).getDay();
  const daysInMonth = new Date(year, month + 1, 0).getDate();

  // find daily notes
  const dailyNoteDates = new Set(Object.values(notes).filter(n => /^\d{4}-\d{2}-\d{2}$/.test(n.title)).map(n => n.title));

  let html = `<div class="cal-header">
    <button class="cal-nav" onclick="calNav(-1)">‹</button>
    <span class="cal-title">${monthNames[month]} ${year}</span>
    <button class="cal-nav" onclick="calNav(1)">›</button>
  </div><div class="cal-grid">`;

  dayNames.forEach(d => { html += `<div class="cal-day-name">${d}</div>`; });

  for (let i = 0; i < firstDay; i++) html += `<div class="cal-day empty"></div>`;
  for (let d = 1; d <= daysInMonth; d++) {
    const dateStr = `${year}-${String(month+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
    const isToday = year === today.getFullYear() && month === today.getMonth() && d === today.getDate();
    const hasNote = dailyNoteDates.has(dateStr);
    const classes = ['cal-day', isToday ? 'today' : '', hasNote ? 'has-note' : ''].filter(Boolean).join(' ');
    html += `<div class="${classes}" onclick="openDailyNote('${dateStr}')" title="${dateStr}">${d}</div>`;
  }
  html += '</div>';
  container.innerHTML = html;
}

function calNav(dir) {
  calendarDate.setMonth(calendarDate.getMonth() + dir);
  renderCalendar();
}

function openDailyNote(dateStr) {
  const date = dateStr || new Date().toISOString().slice(0, 10);
  const existing = findNoteByTitle(date);
  if (existing) { openNote(existing.id); return; }
  // create from template
  const template = (settings.dailyTemplate || '# {{date}}\n\n## Notes\n').replace(/\{\{date\}\}/g, date);
  createNote({ title: date, body: template, type: 'fleeting' });
}

// ════════════════════════════════════════════════
//  EDITOR EVENTS
// ════════════════════════════════════════════════

function onTitleChange(val) {
  if (!currentNoteId || !notes[currentNoteId]) return;
  notes[currentNoteId].title = val;
  notes[currentNoteId].modified = Date.now();
  document.getElementById('note-title-display').textContent = val || 'Untitled';
  document.getElementById('note-modified-display').textContent = 'Modified: ' + formatDate(notes[currentNoteId].modified);
  setSaveIndicator('unsaved');
  scheduleAutoSave();
}

function onEditorChange(val) {
  if (!currentNoteId || !notes[currentNoteId]) return;
  notes[currentNoteId].body = val;
  notes[currentNoteId].modified = Date.now();
  notes[currentNoteId].tags = parseTags(val);
  renderTagsDisplay(notes[currentNoteId]);
  renderOutline(val);
  updateStats(val);
  updatePreview();
  setSaveIndicator('unsaved');
  scheduleAutoSave();
  document.getElementById('note-modified-display').textContent = 'Modified: ' + formatDate(notes[currentNoteId].modified);
}

function onTypeChange(val) {
  if (!currentNoteId || !notes[currentNoteId]) return;
  notes[currentNoteId].type = val;
  saveStorage();
  renderSidebar();
}

function onFolderChange(val) {
  if (!currentNoteId || !notes[currentNoteId]) return;
  notes[currentNoteId].folder = val;
  saveStorage();
  renderSidebar();
}

function scheduleAutoSave() {
  clearTimeout(saveTimer);
  saveTimer = setTimeout(autoSave, 1000);
}

// ════════════════════════════════════════════════
//  MARKDOWN TOOLBAR
// ════════════════════════════════════════════════

function insertMarkdown(type) {
  const editor = document.getElementById('markdown-editor');
  if (!editor) return;
  const start = editor.selectionStart;
  const end = editor.selectionEnd;
  const selected = editor.value.slice(start, end);
  let before = '', after = '', placeholder = '';

  switch (type) {
    case 'bold': before = '**'; after = '**'; placeholder = 'bold text'; break;
    case 'italic': before = '*'; after = '*'; placeholder = 'italic text'; break;
    case 'h2': before = '\n## '; after = '\n'; placeholder = 'Heading'; break;
    case 'h3': before = '\n### '; after = '\n'; placeholder = 'Heading'; break;
    case 'link': before = '['; after = '](url)'; placeholder = 'link text'; break;
    case 'wikilink': before = '[['; after = ']]'; placeholder = 'Note Title'; break;
    case 'ul': before = '\n- '; after = '\n'; placeholder = 'list item'; break;
    case 'ol': before = '\n1. '; after = '\n'; placeholder = 'list item'; break;
    case 'checkbox': before = '\n- [ ] '; after = ''; placeholder = 'task'; break;
    case 'code': before = '```\n'; after = '\n```'; placeholder = 'code'; break;
    case 'quote': before = '\n> '; after = '\n'; placeholder = 'quote'; break;
    case 'hr': before = '\n\n---\n\n'; after = ''; placeholder = ''; break;
    default: return;
  }

  const text = selected || placeholder;
  const newVal = editor.value.slice(0, start) + before + text + after + editor.value.slice(end);
  editor.value = newVal;
  const newPos = start + before.length + text.length;
  editor.setSelectionRange(newPos, newPos);
  editor.focus();
  onEditorChange(editor.value);
}

// ════════════════════════════════════════════════
//  VIEW MODE
// ════════════════════════════════════════════════

function setViewMode(mode, save = true) {
  if (save) { settings.viewMode = mode; saveSettings(); }
  const ep = document.getElementById('editor-pane');
  const pp = document.getElementById('preview-pane');
  const dh = document.getElementById('split-drag-handle');
  document.getElementById('btn-view-edit').classList.remove('active');
  document.getElementById('btn-view-split').classList.remove('active');
  document.getElementById('btn-view-preview').classList.remove('active');

  if (mode === 'edit') {
    ep.classList.remove('hidden'); pp.classList.add('hidden');
    if (dh) dh.style.display = 'none';
    ep.style.flex = '1';
    document.getElementById('btn-view-edit').classList.add('active');
  } else if (mode === 'preview') {
    ep.classList.add('hidden'); pp.classList.remove('hidden');
    if (dh) dh.style.display = 'none';
    document.getElementById('btn-view-preview').classList.add('active');
    updatePreview();
  } else { // split
    ep.classList.remove('hidden'); pp.classList.remove('hidden');
    if (dh) dh.style.display = 'block';
    // restore split ratio
    const ratio = settings.splitRatio || 0.5;
    ep.style.flex = 'none';
    ep.style.width = (ratio * 100) + '%';
    pp.style.flex = '1';
    document.getElementById('btn-view-split').classList.add('active');
    updatePreview();
  }
}

// ════════════════════════════════════════════════
//  CITATION PANEL
// ════════════════════════════════════════════════

function renderCitationPanel(note) {
  const c = note.citation || {};
  const body = document.getElementById('citation-body');
  const icon = document.getElementById('citation-toggle-icon');
  const typeDisplay = document.getElementById('citation-type-display');

  // set fields
  document.getElementById('cite-type').value = c.sourceType || settings.defaultCiteType || 'book';
  document.getElementById('cite-authors').value = c.authors || '';
  document.getElementById('cite-source-title').value = c.sourcetitle || '';
  document.getElementById('cite-container').value = c.container || '';
  document.getElementById('cite-contributors').value = c.contributors || '';
  document.getElementById('cite-version').value = c.version || '';
  document.getElementById('cite-number').value = c.number || '';
  document.getElementById('cite-publisher').value = c.publisher || '';
  document.getElementById('cite-pub-date').value = c.pubDate || '';
  document.getElementById('cite-location').value = c.location || '';
  document.getElementById('cite-access-date').value = c.accessDate || '';

  const expanded = c.expanded || note.type === 'literature';
  if (expanded) {
    body.classList.add('open');
    icon.classList.add('open');
  } else {
    body.classList.remove('open');
    icon.classList.remove('open');
  }

  if (c.generated) {
    const prev = document.getElementById('citation-preview');
    prev.style.display = 'block';
    prev.innerHTML = c.generated;
    document.getElementById('citation-post-actions').style.display = 'flex';
  } else {
    document.getElementById('citation-preview').style.display = 'none';
    document.getElementById('citation-post-actions').style.display = 'none';
  }

  typeDisplay.textContent = c.sourceType ? c.sourceType.charAt(0).toUpperCase() + c.sourceType.slice(1) : '';
}

function toggleCitationExpanded() {
  if (!currentNoteId || !notes[currentNoteId]) return;
  const body = document.getElementById('citation-body');
  const icon = document.getElementById('citation-toggle-icon');
  const expanded = body.classList.toggle('open');
  icon.classList.toggle('open', expanded);
  if (!notes[currentNoteId].citation) notes[currentNoteId].citation = {};
  notes[currentNoteId].citation.expanded = expanded;
  saveStorage();
}

function toggleCitationPanel() {
  toggleCitationExpanded();
}

function onCiteFieldChange() {
  if (!currentNoteId || !notes[currentNoteId]) return;
  if (!notes[currentNoteId].citation) notes[currentNoteId].citation = {};
  const c = notes[currentNoteId].citation;
  c.sourceType = document.getElementById('cite-type').value;
  c.authors = document.getElementById('cite-authors').value;
  c.sourcetitle = document.getElementById('cite-source-title').value;
  c.container = document.getElementById('cite-container').value;
  c.contributors = document.getElementById('cite-contributors').value;
  c.version = document.getElementById('cite-version').value;
  c.number = document.getElementById('cite-number').value;
  c.publisher = document.getElementById('cite-publisher').value;
  c.pubDate = document.getElementById('cite-pub-date').value;
  c.location = document.getElementById('cite-location').value;
  c.accessDate = document.getElementById('cite-access-date').value;
  document.getElementById('citation-type-display').textContent = c.sourceType ? c.sourceType.charAt(0).toUpperCase() + c.sourceType.slice(1) : '';
  scheduleAutoSave();
}

// ════════════════════════════════════════════════
//  MLA CITATION GENERATOR
// ════════════════════════════════════════════════

function formatMlaAuthors(authorsStr) {
  if (!authorsStr.trim()) return '';
  const authors = authorsStr.split(',').map(a => a.trim()).filter(Boolean);

  // Try to parse "Last, First" pattern — check if every other comma is a name separator
  // Simple split on " and "
  const parts = authorsStr.split(/ and /i).map(a => a.trim()).filter(Boolean);

  if (parts.length === 0) return '';
  if (parts.length === 1) return parts[0] + '.';
  if (parts.length === 2) return parts[0] + ', and ' + parts[1] + '.';
  return parts[0] + ', et al.';
}

function isLongWork(sourceType) {
  return ['book', 'film', 'podcast'].includes(sourceType);
}

function generateMlaCitation() {
  if (!currentNoteId || !notes[currentNoteId]) return '';
  const c = notes[currentNoteId].citation || {};
  const type = c.sourceType || 'book';

  const parts = [];

  // Author
  const authorStr = formatMlaAuthors(c.authors || '');
  if (authorStr) parts.push(authorStr);

  // Title of source
  if (c.sourcetitle) {
    // Short works: quotes; Long works: italics
    const isLong = isLongWork(type);
    if (isLong) {
      parts.push(`<em>${c.sourcetitle}</em>,`);
    } else {
      parts.push(`"${c.sourcetitle},"`);
    }
  }

  // Container
  if (c.container) parts.push(`<em>${c.container}</em>,`);

  // Other contributors
  if (c.contributors) parts.push(c.contributors + ',');

  // Version/edition
  if (c.version) parts.push(c.version + ',');

  // Number
  if (c.number) parts.push(c.number + ',');

  // Publisher
  if (c.publisher) parts.push(c.publisher + ',');

  // Publication date
  if (c.pubDate) parts.push(c.pubDate + ',');

  // Location
  if (c.location) {
    let loc = c.location;
    if (loc.startsWith('https://')) loc = loc.slice(8);
    else if (loc.startsWith('http://')) loc = loc.slice(7);
    parts.push(loc + '.');
  }

  // Access date (online sources)
  if (c.accessDate) parts.push('Accessed ' + c.accessDate + '.');

  if (parts.length === 0) return '';

  // Clean up punctuation - remove double commas/periods
  let citation = parts.join(' ');
  citation = citation.replace(/,\s*,/g, ',').replace(/\.\s*\./g, '.');

  return citation;
}

function generateCitation() {
  const citation = generateMlaCitation();
  if (!citation) { toast('Please fill in citation fields', 'error'); return; }
  if (!notes[currentNoteId].citation) notes[currentNoteId].citation = {};
  notes[currentNoteId].citation.generated = citation;
  const prev = document.getElementById('citation-preview');
  prev.style.display = 'block';
  prev.innerHTML = citation;
  document.getElementById('citation-post-actions').style.display = 'flex';
  saveStorage();
  toast('Citation generated', 'success');
}

function copyCitation() {
  const c = notes[currentNoteId]?.citation?.generated;
  if (!c) return;
  // strip HTML for clipboard
  const temp = document.createElement('div');
  temp.innerHTML = c;
  navigator.clipboard.writeText(temp.textContent || temp.innerText);
  toast('Citation copied', 'success');
}

function insertCitationInNote() {
  const c = notes[currentNoteId]?.citation?.generated;
  if (!c) return;
  const temp = document.createElement('div');
  temp.innerHTML = c;
  const text = temp.textContent || temp.innerText;
  const editor = document.getElementById('markdown-editor');
  const existing = editor.value;
  const separator = existing.includes('## Works Cited') ? '\n' : '\n\n## Works Cited\n\n';
  editor.value = existing + separator + text + '\n';
  onEditorChange(editor.value);
  toast('Citation inserted', 'success');
}

// ════════════════════════════════════════════════
//  GRAPH VIEW
// ════════════════════════════════════════════════

function showGraphView() {
  document.getElementById('graph-view').classList.add('visible');
  // populate tag filter
  const tagSelect = document.getElementById('graph-tag-filter');
  if (tagSelect) {
    const allTags = [...new Set(Object.values(notes).flatMap(n => n.tags || []))].sort();
    tagSelect.innerHTML = '<option value="">All tags</option>' + allTags.map(t => `<option value="${t}">#${t}</option>`).join('');
  }
  renderGraph();
}

function hideGraphView() {
  document.getElementById('graph-view').classList.remove('visible');
  hideGraphHoverCard();
}

function hideGraphHoverCard() {
  const card = document.getElementById('graph-hover-card');
  if (card) card.classList.remove('visible');
}

function renderGraph() {
  const svg = d3.select('#graph-svg');
  svg.selectAll('*').remove();

  const container = document.getElementById('graph-container');
  const W = container.clientWidth;
  const H = container.clientHeight;

  svg.attr('width', W).attr('height', H);

  const colorMode = document.getElementById('graph-color-mode')?.value || 'type';
  const tagFilter = document.getElementById('graph-tag-filter')?.value || '';

  let noteList = Object.values(notes);
  if (tagFilter) {
    noteList = noteList.filter(n => (n.tags || []).includes(tagFilter));
  }

  document.getElementById('graph-stats').textContent = `${noteList.length} notes, ${noteList.reduce((sum, n) => sum + parseWikiLinks(n.body||'').length, 0)} links`;

  if (noteList.length === 0) {
    svg.append('text').attr('x', W/2).attr('y', H/2).attr('text-anchor', 'middle')
      .attr('fill', 'var(--text-dim)').attr('font-size', 14).text('No notes to display');
    return;
  }

  const noteIds = new Set(noteList.map(n => n.id));

  // Build nodes and links
  const nodes = noteList.map(n => ({ id: n.id, title: n.title || 'Untitled', type: n.type, folder: n.folder || 'root', tags: n.tags || [] }));
  const links = [];
  noteList.forEach(n => {
    const wl = parseWikiLinks(n.body || '');
    wl.forEach(target => {
      const targetNote = findNoteByTitle(target);
      if (targetNote && noteIds.has(targetNote.id) && targetNote.id !== n.id) {
        links.push({ source: n.id, target: targetNote.id });
      }
    });
  });

  // Mark orphan nodes
  const connectedIds = new Set(links.flatMap(l => [
    typeof l.source === 'object' ? l.source.id : l.source,
    typeof l.target === 'object' ? l.target.id : l.target
  ]));
  nodes.forEach(n => { n.isOrphan = !connectedIds.has(n.id); });

  const typeColors = { fleeting: '#fb923c', literature: '#60a5fa', permanent: '#4ade80' };
  const folderColors = {};
  const folderPalette = ['#c9a84c','#a78bfa','#f472b6','#22d3ee','#a3e635'];
  const uniqueFolders = [...new Set(noteList.map(n => n.folder || 'root'))];
  uniqueFolders.forEach((f, i) => { folderColors[f] = folderPalette[i % folderPalette.length]; });
  const allTags = [...new Set(noteList.flatMap(n => n.tags || []))];
  const tagColPalette = ['#c9a84c','#a78bfa','#f472b6','#22d3ee','#4ade80'];

  function getColor(d) {
    if (colorMode === 'type') return d.isOrphan ? '#52525b' : (typeColors[d.type] || '#c9a84c');
    if (colorMode === 'folder') return folderColors[d.folder] || '#c9a84c';
    if (d.tags && d.tags.length > 0) {
      const idx = allTags.indexOf(d.tags[0]);
      return tagColPalette[idx % tagColPalette.length];
    }
    return '#52525b';
  }

  // Force simulation: orphans cluster on the edges
  const sim = d3.forceSimulation(nodes)
    .force('link', d3.forceLink(links).id(d => d.id).distance(90))
    .force('charge', d3.forceManyBody().strength(d => d.isOrphan ? -30 : -150))
    .force('center', d3.forceCenter(W/2, H/2))
    .force('collision', d3.forceCollide(d => d.isOrphan ? 14 : 22))
    .force('orphan-push', d3.forceRadial(d => d.isOrphan ? Math.min(W, H) * 0.42 : 0, W/2, H/2).strength(0.08));

  const g = svg.append('g');
  svg.call(d3.zoom().scaleExtent([0.1, 4]).on('zoom', e => g.attr('transform', e.transform)));

  const link = g.append('g').selectAll('line').data(links).join('line')
    .attr('stroke', 'var(--border)').attr('stroke-width', 1.5).attr('opacity', 0.7);

  const node = g.append('g').selectAll('g').data(nodes).join('g')
    .attr('class', 'graph-node')
    .call(d3.drag()
      .on('start', (e, d) => { if (!e.active) sim.alphaTarget(0.3).restart(); d.fx = d.x; d.fy = d.y; })
      .on('drag', (e, d) => { d.fx = e.x; d.fy = e.y; })
      .on('end', (e, d) => { if (!e.active) sim.alphaTarget(0); d.fx = null; d.fy = null; }));

  node.append('circle')
    .attr('r', d => {
      if (d.isOrphan) return 5;
      const lc = links.filter(l => {
        const s = typeof l.source === 'object' ? l.source.id : l.source;
        const t = typeof l.target === 'object' ? l.target.id : l.target;
        return s === d.id || t === d.id;
      }).length;
      return Math.min(6 + lc * 2.5, 22);
    })
    .attr('fill', d => getColor(d))
    .attr('fill-opacity', d => d.isOrphan ? 0.5 : 0.9)
    .attr('stroke', 'var(--bg)').attr('stroke-width', 2)
    .style('cursor', 'pointer')
    .on('mouseover', (e, d) => showGraphHoverCard(e, d))
    .on('mousemove', (e) => moveGraphHoverCard(e))
    .on('mouseout', () => hideGraphHoverCard())
    .on('click', (e, d) => { hideGraphView(); openNote(d.id); });

  // Label only non-orphan nodes
  node.filter(d => !d.isOrphan)
    .append('text')
    .attr('dx', 13).attr('dy', 4)
    .attr('fill', 'var(--text-muted)').attr('font-size', 10.5)
    .attr('pointer-events', 'none')
    .text(d => d.title.length > 22 ? d.title.slice(0, 22) + '…' : d.title);

  // Orphan cluster label
  if (nodes.filter(n => n.isOrphan).length > 0) {
    const orphanCount = nodes.filter(n => n.isOrphan).length;
    g.append('text')
      .attr('x', W - 20).attr('y', 30)
      .attr('text-anchor', 'end')
      .attr('fill', 'var(--text-dim)').attr('font-size', 10)
      .text(`⬤ ${orphanCount} unlinked note${orphanCount !== 1 ? 's' : ''}`);
  }

  sim.on('tick', () => {
    link.attr('x1', d => d.source.x).attr('y1', d => d.source.y)
        .attr('x2', d => d.target.x).attr('y2', d => d.target.y);
    node.attr('transform', d => `translate(${d.x},${d.y})`);
  });
}

function showGraphHoverCard(event, d) {
  const card = document.getElementById('graph-hover-card');
  const note = notes[d.id];
  if (!note || !card) return;
  // strip markdown from body for excerpt
  const cleanBody = (note.body || '').replace(/#{1,6}\s/g,'').replace(/\*\*?|__?|~~|`{1,3}/g,'').replace(/\[\[([^\]]+)\]\]/g,'$1').replace(/\[([^\]]+)\]\([^\)]+\)/g,'$1').replace(/^>\s?/gm,'').trim();
  const excerpt = cleanBody.slice(0, 120) + (cleanBody.length > 120 ? '…' : '');
  document.getElementById('ghc-title').textContent = note.title || 'Untitled';
  document.getElementById('ghc-meta').textContent = `${note.type} · ${(note.tags||[]).map(t=>'#'+t).join(' ')} · ${new Date(note.modified).toLocaleDateString()}`;
  document.getElementById('ghc-excerpt').textContent = excerpt;
  card.classList.add('visible');
  moveGraphHoverCard(event);
}

function moveGraphHoverCard(event) {
  const card = document.getElementById('graph-hover-card');
  if (!card) return;
  const x = event.clientX + 16;
  const y = event.clientY + 10;
  card.style.left = Math.min(x, window.innerWidth - 290) + 'px';
  card.style.top = Math.min(y, window.innerHeight - 160) + 'px';
}

// ════════════════════════════════════════════════
//  COMMAND PALETTE
// ════════════════════════════════════════════════

let cmdSelectedIdx = 0;

const COMMANDS = [
  { icon: '📝', label: 'New Note', hint: 'Alt+N', action: () => createNote() },
  { icon: '📅', label: 'Open Daily Note', hint: 'Alt+D', action: () => openDailyNote() },
  { icon: '⬡', label: 'Open Graph View', hint: 'Alt+G', action: () => showGraphView() },
  { icon: '🔍', label: 'Global Search', hint: 'Alt+F', action: () => { closeCommandPalette(); openGlobalSearch(); }},
  { icon: '🌙', label: 'Toggle Dark/Light Mode', action: () => toggleTheme() },
  { icon: '⚙', label: 'Open Settings', action: () => openSettings() },
  { icon: '⭐', label: 'Star / Unstar Current Note', hint: 'Alt+*', action: () => starCurrentNote() },
  { icon: '📚', label: 'View Bibliography', action: () => showBibliography() },
  { icon: '🗂', label: 'Open Library', action: () => showLibrary() },
  { icon: '➕', label: 'Add to Library', action: () => { closeCommandPalette(); openLibraryItemModal(); }},
  { icon: '?', label: 'Help & Keyboard Shortcuts', hint: 'Alt+?', action: () => openHelp() },
  { icon: '↓', label: 'Export Current Note (Markdown)', action: () => exportNote('md') },
  { icon: '↓', label: 'Export Current Note (Word)', action: () => exportNote('docx') },
  { icon: '📤', label: 'Export All Notes (JSON)', action: () => exportAllJSON() },
];

function openCommandPalette() {
  const palette = document.getElementById('cmd-palette');
  palette.classList.add('visible');
  const input = document.getElementById('cmd-input');
  input.value = '';
  input.focus();
  filterCommands('');
}

function closeCommandPalette() {
  document.getElementById('cmd-palette').classList.remove('visible');
}

function filterCommands(q) {
  const results = document.getElementById('cmd-results');
  results.innerHTML = '';
  cmdSelectedIdx = 0;
  const ql = q.toLowerCase();

  // Commands
  const matchedCmds = COMMANDS.filter(c => c.label.toLowerCase().includes(ql) || !ql);
  if (matchedCmds.length > 0) {
    const sectionLabel = document.createElement('div');
    sectionLabel.className = 'cmd-section-label';
    sectionLabel.textContent = 'Commands';
    results.appendChild(sectionLabel);
    matchedCmds.forEach((cmd, i) => {
      const div = document.createElement('div');
      div.className = 'cmd-item' + (i === 0 && !ql ? ' selected' : '');
      div.innerHTML = `<span class="cmd-item-icon">${cmd.icon}</span><span class="cmd-item-label">${cmd.label}</span><span class="cmd-item-hint">${cmd.hint || ''}</span>`;
      div.onclick = () => { closeCommandPalette(); cmd.action(); };
      results.appendChild(div);
    });
  }

  if (ql.length > 0) {
    // Notes
    const matchedNotes = Object.values(notes).filter(n =>
      (n.title || '').toLowerCase().includes(ql)
    ).slice(0, 6);
    if (matchedNotes.length > 0) {
      const sectionLabel = document.createElement('div');
      sectionLabel.className = 'cmd-section-label';
      sectionLabel.textContent = 'Open Note';
      results.appendChild(sectionLabel);
      matchedNotes.forEach(n => {
        const div = document.createElement('div');
        div.className = 'cmd-item';
        const typeColors = { fleeting:'#fb923c', literature:'#60a5fa', permanent:'#4ade80' };
        div.innerHTML = `<span class="cmd-item-icon" style="color:${typeColors[n.type]||'var(--accent)'}">📄</span><span class="cmd-item-label">${n.title || 'Untitled'}</span><span class="cmd-item-hint">${n.type}</span>`;
        div.onclick = () => { closeCommandPalette(); openNote(n.id); };
        results.appendChild(div);
      });
    }

    // Library items
    const matchedLib = Object.values(library).filter(item =>
      (item.title || '').toLowerCase().includes(ql) || (item.author || '').toLowerCase().includes(ql)
    ).slice(0, 4);
    if (matchedLib.length > 0) {
      const sectionLabel = document.createElement('div');
      sectionLabel.className = 'cmd-section-label';
      sectionLabel.textContent = 'Library';
      results.appendChild(sectionLabel);
      matchedLib.forEach(item => {
        const div = document.createElement('div');
        div.className = 'cmd-item';
        const icon = LIB_TYPE_ICONS[item.type] || '📦';
        div.innerHTML = `<span class="cmd-item-icon">${icon}</span><span class="cmd-item-label">${item.title}</span><span class="cmd-item-hint">${item.author || item.type}</span>`;
        div.onclick = () => { closeCommandPalette(); showLibrary(); setTimeout(() => openLibraryItemModal(item.id), 50); };
        results.appendChild(div);
      });
    }
  }
}

function cmdKeyDown(e) {
  const items = document.querySelectorAll('#cmd-results .cmd-item');
  if (e.key === 'ArrowDown') {
    cmdSelectedIdx = Math.min(cmdSelectedIdx + 1, items.length - 1);
    items.forEach((item, i) => item.classList.toggle('selected', i === cmdSelectedIdx));
    e.preventDefault();
  } else if (e.key === 'ArrowUp') {
    cmdSelectedIdx = Math.max(cmdSelectedIdx - 1, 0);
    items.forEach((item, i) => item.classList.toggle('selected', i === cmdSelectedIdx));
    e.preventDefault();
  } else if (e.key === 'Enter') {
    items[cmdSelectedIdx]?.click();
    e.preventDefault();
  } else if (e.key === 'Escape') {
    closeCommandPalette();
  }
}

// ════════════════════════════════════════════════
//  GLOBAL SEARCH
// ════════════════════════════════════════════════

function openGlobalSearch() {
  document.getElementById('search-panel').classList.add('visible');
  setTimeout(() => document.getElementById('global-search-input').focus(), 50);
}

function closeSearch() {
  document.getElementById('search-panel').classList.remove('visible');
}

let searchTypeFilter = 'all';

function setSearchFilter(type, el) {
  searchTypeFilter = type;
  document.querySelectorAll('#search-filters .search-filter-btn').forEach(b => b.classList.remove('active'));
  el.classList.add('active');
  globalSearch(document.getElementById('global-search-input').value);
}

function stripMarkdown(text) {
  return text
    .replace(/#{1,6}\s/g, '')
    .replace(/\*\*([^*]+)\*\*/g, '$1')
    .replace(/\*([^*]+)\*/g, '$1')
    .replace(/__([^_]+)__/g, '$1')
    .replace(/_([^_]+)_/g, '$1')
    .replace(/`{3}[\s\S]*?`{3}/g, '')
    .replace(/`([^`]+)`/g, '$1')
    .replace(/\[\[([^\]]+)\]\]/g, '$1')
    .replace(/\[([^\]]+)\]\([^\)]+\)/g, '$1')
    .replace(/^>\s?/gm, '')
    .replace(/^[-*+]\s/gm, '')
    .replace(/^\d+\.\s/gm, '')
    .replace(/^---+$/gm, '')
    .trim();
}

function globalSearch(q) {
  const results = document.getElementById('search-results');
  const statsEl = document.getElementById('search-stats');
  results.innerHTML = '';
  if (!q.trim()) { if (statsEl) statsEl.textContent = ''; return; }
  const ql = q.toLowerCase();
  const qEscaped = q.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');

  let allNotes = Object.values(notes);
  // apply type filter
  if (searchTypeFilter === 'starred') allNotes = allNotes.filter(n => n.starred);
  else if (searchTypeFilter !== 'all') allNotes = allNotes.filter(n => n.type === searchTypeFilter);

  const matches = allNotes
    .map(n => {
      const titleLower = (n.title || '').toLowerCase();
      const bodyClean = stripMarkdown(n.body || '');
      const bodyLower = bodyClean.toLowerCase();
      const titleMatch = titleLower.includes(ql);
      const bodyMatch = bodyLower.includes(ql);
      if (!titleMatch && !bodyMatch) return null;
      // score: title match is weighted higher
      const score = (titleMatch ? 100 : 0) + (bodyLower.split(ql).length - 1) * 2;
      return { n, titleMatch, bodyClean, bodyLower, score };
    })
    .filter(Boolean)
    .sort((a, b) => b.score - a.score);

  if (statsEl) statsEl.textContent = matches.length > 0 ? `${matches.length} result${matches.length !== 1 ? 's' : ''}` : '';

  if (matches.length === 0) {
    results.innerHTML = '<div style="padding:16px 18px;color:var(--text-dim);font-size:13px;">No results found</div>';
    return;
  }

  matches.forEach(({ n, titleMatch, bodyClean }) => {
    const bodyIdx = bodyClean.toLowerCase().indexOf(ql);
    let excerpt = '';
    if (bodyIdx >= 0) {
      const start = Math.max(0, bodyIdx - 50);
      const raw = bodyClean.slice(start, bodyIdx + 100);
      excerpt = raw.replace(new RegExp(qEscaped, 'gi'), m => `<span class="search-highlight">${m}</span>`);
      if (start > 0) excerpt = '…' + excerpt;
    }

    const div = document.createElement('div');
    div.className = 'search-result';
    const typeColors = { fleeting: 'var(--orange)', literature: 'var(--blue)', permanent: 'var(--green)' };
    const typeDot = `<span style="display:inline-block;width:7px;height:7px;border-radius:50%;background:${typeColors[n.type]||'var(--accent)'};margin-right:5px;vertical-align:middle;"></span>`;
    const starIcon = n.starred ? '<span style="color:var(--accent);margin-left:4px;">⭐</span>' : '';
    const highlightedTitle = (n.title || 'Untitled').replace(new RegExp(qEscaped, 'gi'), m => `<span class="search-highlight">${m}</span>`);
    const modDate = new Date(n.modified).toLocaleDateString();
    div.innerHTML = `
      <div class="search-result-title">${typeDot}${highlightedTitle}${starIcon}<span style="font-size:10px;color:var(--text-dim);margin-left:8px;">${modDate}</span></div>
      ${excerpt ? `<div class="search-result-excerpt">${excerpt}</div>` : ''}`;
    div.onclick = () => { closeSearch(); openNote(n.id); };
    results.appendChild(div);
  });
}

// ════════════════════════════════════════════════
//  FIND IN NOTE
// ════════════════════════════════════════════════

function openFindBar() {
  const bar = document.getElementById('find-bar');
  bar.classList.add('visible');
  setTimeout(() => document.getElementById('find-input').focus(), 50);
}

function closeFindBar() {
  document.getElementById('find-bar').classList.remove('visible');
}

function findInNote(q) {
  const editor = document.getElementById('markdown-editor');
  const count = document.getElementById('find-count');
  if (!q) { count.textContent = ''; return; }
  const matches = (editor.value.match(new RegExp(q.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'), 'gi')) || []).length;
  count.textContent = `${matches} match${matches !== 1 ? 'es' : ''}`;
}

// ════════════════════════════════════════════════
//  SETTINGS
// ════════════════════════════════════════════════

function openSettings() {
  // populate
  document.getElementById('setting-theme').value = settings.theme || 'dark';
  document.getElementById('setting-editor-font').value = settings.editorFont || 'mono';
  document.getElementById('setting-font-size').value = settings.fontSize || 14;
  document.getElementById('setting-view-mode').value = settings.viewMode || 'split';
  document.getElementById('setting-default-type').value = settings.defaultType || 'fleeting';
  document.getElementById('setting-default-cite-type').value = settings.defaultCiteType || 'book';
  document.getElementById('setting-daily-template').value = settings.dailyTemplate || '';
  document.getElementById('settings-modal').classList.add('visible');
}

function closeSettings() {
  document.getElementById('settings-modal').classList.remove('visible');
}

function applySettings() {
  settings.theme = document.getElementById('setting-theme').value;
  settings.editorFont = document.getElementById('setting-editor-font').value;
  settings.fontSize = parseInt(document.getElementById('setting-font-size').value) || 14;
  settings.viewMode = document.getElementById('setting-view-mode').value;
  settings.defaultType = document.getElementById('setting-default-type').value;
  settings.defaultCiteType = document.getElementById('setting-default-cite-type').value;
  settings.dailyTemplate = document.getElementById('setting-daily-template').value;
  saveSettings();
  applyTheme();
  applyEditorFont();
}

function applyTheme() {
  document.documentElement.setAttribute('data-theme', settings.theme || 'dark');
}

function applyEditorFont() {
  const fontMap = { mono: "'JetBrains Mono', monospace", sans: "'Sora', sans-serif", serif: "'Crimson Pro', serif" };
  const font = fontMap[settings.editorFont] || fontMap.mono;
  document.documentElement.style.setProperty('--editor-font', font);
  const editor = document.getElementById('markdown-editor');
  if (editor) {
    editor.style.fontFamily = font;
    editor.style.fontSize = (settings.fontSize || 14) + 'px';
  }
}

function toggleTheme() {
  settings.theme = settings.theme === 'dark' ? 'light' : 'dark';
  saveSettings();
  applyTheme();
  toast('Switched to ' + settings.theme + ' mode', 'info');
}

// ════════════════════════════════════════════════
//  BIBLIOGRAPHY
// ════════════════════════════════════════════════

function showBibliography() {
  const view = document.getElementById('bibliography-view');
  view.classList.add('visible');
  renderBibliography();
}

function hideBibliography() {
  document.getElementById('bibliography-view').classList.remove('visible');
}

function getAllCitations() {
  const entries = [];
  const seen = new Set();
  Object.values(notes).forEach(n => {
    if (n.citation?.generated) {
      const key = (n.citation.authors || '') + (n.citation.sourcetitle || '');
      if (!seen.has(key)) {
        seen.add(key);
        entries.push({ note: n, citation: n.citation });
      }
    }
  });
  // sort alphabetically by generated citation text
  const temp = document.createElement('div');
  return entries.sort((a, b) => {
    temp.innerHTML = a.citation.generated;
    const ta = temp.textContent;
    temp.innerHTML = b.citation.generated;
    const tb = temp.textContent;
    return ta.localeCompare(tb);
  });
}

function renderBibliography() {
  const container = document.getElementById('bibliography-entries');
  container.innerHTML = '';
  const entries = getAllCitations();
  if (entries.length === 0) {
    container.innerHTML = '<div style="color:var(--text-dim);font-size:14px;">No citations yet. Add citations to notes via the Source/Citation panel.</div>';
    return;
  }
  entries.forEach(({ citation, note }) => {
    const div = document.createElement('div');
    div.className = 'bib-entry';
    div.innerHTML = citation.generated;
    div.title = 'From: ' + (note.title || 'Untitled');
    div.style.cursor = 'pointer';
    div.onclick = () => { hideBibliography(); openNote(note.id); };
    container.appendChild(div);
  });
}

function copyBibliography() {
  const entries = getAllCitations();
  if (entries.length === 0) { toast('No citations to copy', 'error'); return; }
  const temp = document.createElement('div');
  const lines = entries.map(({ citation }) => {
    temp.innerHTML = citation.generated;
    return temp.textContent;
  });
  navigator.clipboard.writeText('Works Cited\n\n' + lines.join('\n\n'));
  toast('Bibliography copied', 'success');
}

function exportBibliography() {
  const entries = getAllCitations();
  if (entries.length === 0) { toast('No citations to export', 'error'); return; }
  const temp = document.createElement('div');
  const lines = entries.map(({ citation }) => {
    temp.innerHTML = citation.generated;
    return temp.textContent;
  });
  const text = 'Works Cited\n\n' + lines.join('\n\n');
  downloadFile('works-cited.txt', text, 'text/plain');
  toast('Bibliography exported', 'success');
}

// ════════════════════════════════════════════════
//  EXPORT / IMPORT
// ════════════════════════════════════════════════

function exportNote(format) {
  if (!currentNoteId || !notes[currentNoteId]) {
    toast('No note selected', 'error'); return;
  }
  const note = notes[currentNoteId];
  const filename = (note.title || 'note').replace(/[^a-z0-9]/gi, '-');

  if (format === 'md') {
    const md = `# ${note.title || 'Untitled'}\n\n${note.body || ''}`;
    downloadFile(filename + '.md', md, 'text/markdown');
    toast('Exported as Markdown', 'success');
  } else if (format === 'docx') {
    exportNoteToDocx(note);
  } else if (format === 'txt') {
    downloadFile(filename + '.txt', `${note.title || 'Untitled'}\n\n${note.body || ''}`, 'text/plain');
    toast('Exported as text', 'success');
  }
}

function exportNoteToDocx(note) {
  // Build simple HTML that can be converted - using a plain text approach
  const temp = document.createElement('div');
  let body = note.body || '';

  // append citation if exists
  const c = note.citation;
  let citationText = '';
  if (c?.generated) {
    temp.innerHTML = c.generated;
    citationText = '\n\nWorks Cited\n\n' + temp.textContent;
  }

  const fullText = `${note.title || 'Untitled'}\n\n${body}${citationText}`;
  // Create a simple RTF instead since docx library may not be available
  const rtf = '{\\rtf1\\ansi\\deff0\n' +
    '{\\fonttbl{\\f0 Times New Roman;}{\\f1 Courier New;}}\n' +
    '\\f0\\fs28\\b ' + escapeRtf(note.title || 'Untitled') + '\\b0\\fs24\n\\par\\par\n' +
    body.split('\n').map(line => {
      if (line.startsWith('# ')) return '\\fs28\\b ' + escapeRtf(line.slice(2)) + '\\b0\\fs24\\par\n';
      if (line.startsWith('## ')) return '\\fs26\\b ' + escapeRtf(line.slice(3)) + '\\b0\\fs24\\par\n';
      if (line.startsWith('### ')) return '\\fs24\\b ' + escapeRtf(line.slice(4)) + '\\b0\\fs24\\par\n';
      return escapeRtf(line) + '\\par\n';
    }).join('') +
    (citationText ? '\\par\\par\\b Works Cited\\b0\\par\\par\n' + citationText.split('\n').slice(3).map(l => '\\li720\\fi-720 ' + escapeRtf(l) + '\\li0\\fi0\\par\n').join('') : '') +
    '}';

  downloadFile((note.title || 'note').replace(/[^a-z0-9]/gi, '-') + '.rtf', rtf, 'application/rtf');
  toast('Exported as RTF (open in Word)', 'success');
}

function escapeRtf(str) {
  return str.replace(/\\/g, '\\\\').replace(/\{/g, '\\{').replace(/\}/g, '\\}')
    .replace(/[^\x00-\x7F]/g, c => `\\u${c.charCodeAt(0)}?`);
}

function exportAllJSON() {
  const data = { notes, settings, folders, library, exported: new Date().toISOString() };
  downloadFile('zettelkasten-backup.json', JSON.stringify(data, null, 2), 'application/json');
  localStorage.setItem('zk_last_exported', Date.now().toString());
  document.getElementById('backup-banner').classList.remove('visible');
  toast('All notes exported', 'success');
}

function importJSON(input) {
  const file = input.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = e => {
    try {
      const data = JSON.parse(e.target.result);
      let imported = 0, skipped = 0;
      if (data.notes) {
        Object.entries(data.notes).forEach(([id, note]) => {
          if (!notes[id]) { notes[id] = note; imported++; }
          else skipped++;
        });
      }
      if (data.folders) {
        data.folders.forEach(f => { if (!folders.includes(f)) folders.push(f); });
      }
      saveStorage();
      renderSidebar();
      toast(`Imported ${imported} notes, skipped ${skipped}`, 'success');
    } catch(err) {
      toast('Invalid JSON file', 'error');
    }
  };
  reader.readAsText(file);
  input.value = '';
}

function exportExcel() {
  const rows = [['ID', 'Title', 'Type', 'Folder', 'Tags', 'Created', 'Modified', 'Word Count', 'Has Citation']];
  Object.values(notes).forEach(n => {
    rows.push([
      n.id, n.title || 'Untitled', n.type, n.folder || '', (n.tags || []).join(', '),
      new Date(n.created).toLocaleDateString(), new Date(n.modified).toLocaleDateString(),
      ((n.body || '').trim() ? (n.body || '').trim().split(/\s+/).length : 0),
      n.citation?.generated ? 'Yes' : 'No'
    ]);
  });
  const ws = XLSX.utils.aoa_to_sheet(rows);
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, 'Notes');
  XLSX.writeFile(wb, 'zettelkasten-notes.xlsx');
  toast('Excel exported', 'success');
}

function downloadFile(filename, content, type) {
  const blob = new Blob([content], { type });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url; a.download = filename; a.click();
  URL.revokeObjectURL(url);
}

function confirmDeleteAll() {
  if (confirm('Delete ALL notes? This cannot be undone.')) {
    notes = {};
    recentNotes = [];
    saveStorage();
    currentNoteId = null;
    showEmptyState();
    renderSidebar();
    closeSettings();
    toast('All notes deleted', 'info');
  }
}

// ════════════════════════════════════════════════
//  FOLDERS
// ════════════════════════════════════════════════

function promptNewFolder() {
  const name = prompt('Folder name:');
  if (name && name.trim()) {
    const folderName = name.trim();
    if (!folders.includes(folderName)) {
      folders.push(folderName);
      saveStorage();
      renderSidebar();
      renderFolderSelect(notes[currentNoteId]?.folder);
      toast('Folder created: ' + folderName, 'success');
    }
  }
}

function deleteFolder(folder) {
  if (!confirm(`Delete folder "${folder}"? Notes will be moved to root.`)) return;
  folders = folders.filter(f => f !== folder);
  Object.values(notes).forEach(n => { if (n.folder === folder) n.folder = ''; });
  saveStorage();
  renderSidebar();
  renderFolderSelect(notes[currentNoteId]?.folder);
  toast('Folder deleted', 'info');
}

// ════════════════════════════════════════════════
//  SIDEBAR SECTIONS
// ════════════════════════════════════════════════

function toggleSection(name) {
  const body = document.getElementById('body-' + name);
  const toggle = document.getElementById('toggle-' + name);
  if (!body || !toggle) return;
  body.classList.toggle('collapsed');
  toggle.classList.toggle('open', !body.classList.contains('collapsed'));
}

function toggleSidebar() {
  const sidebar = document.getElementById('sidebar');
  const isMobile = window.innerWidth <= 700;
  if (isMobile) {
    sidebar.classList.toggle('mobile-open');
    document.getElementById('mobile-sidebar-overlay').classList.toggle('visible', sidebar.classList.contains('mobile-open'));
  } else {
    sidebar.classList.toggle('collapsed');
  }
}

function closeMobileSidebar() {
  document.getElementById('sidebar').classList.remove('mobile-open');
  document.getElementById('mobile-sidebar-overlay').classList.remove('visible');
}

function toggleOutline() {
  document.getElementById('outline-panel').classList.toggle('collapsed');
}

// ════════════════════════════════════════════════
//  TOAST NOTIFICATIONS
// ════════════════════════════════════════════════

function toast(message, type = 'info') {
  const container = document.getElementById('toast-container');
  const icons = { success: '✓', error: '✕', info: '●' };
  const div = document.createElement('div');
  div.className = `toast ${type}`;
  div.innerHTML = `<span style="font-size:13px;">${icons[type] || '●'}</span>${message}`;
  container.appendChild(div);
  setTimeout(() => {
    div.style.animation = 'toastOut 0.3s ease forwards';
    setTimeout(() => div.remove(), 300);
  }, 2500);
}

// ════════════════════════════════════════════════
//  KEYBOARD SHORTCUTS
// ════════════════════════════════════════════════

document.addEventListener('keydown', e => {
  const alt = e.altKey && !e.ctrlKey && !e.metaKey;
  if (!alt) return;

  if (e.key === 'n') { e.preventDefault(); createNote(); }
  else if (e.key === 'd') { e.preventDefault(); openDailyNote(); }
  else if (e.key === 'k') { e.preventDefault(); openCommandPalette(); }
  else if (e.key === 'g') { e.preventDefault(); showGraphView(); }
  else if (e.key === 's') { e.preventDefault(); autoSave(); toast('Saved', 'success'); }
  else if (e.key === 'e') { e.preventDefault(); const vm = settings.viewMode; setViewMode(vm === 'edit' ? 'preview' : vm === 'preview' ? 'split' : 'edit'); }
  else if (e.key === '\\') { e.preventDefault(); setViewMode('split'); }
  else if (e.key === 'b') { e.preventDefault(); insertMarkdown('bold'); }
  else if (e.key === 'i') { e.preventDefault(); insertMarkdown('italic'); }
  else if (e.key === 'f') { e.preventDefault(); openGlobalSearch(); }
  else if (e.key === '/') { e.preventDefault(); openFindBar(); }
  else if (e.key === 'c') { e.preventDefault(); toggleCitationPanel(); }
  else if (e.key === '*') { e.preventDefault(); starCurrentNote(); }
  else if (e.key === '?') { e.preventDefault(); openHelp(); }
});

// Close lib note search results when clicking outside
document.addEventListener('click', e => {
  const sr = document.getElementById('lib-note-search-results');
  if (sr && !sr.contains(e.target) && e.target.id !== 'lib-note-search') {
    sr.classList.remove('visible');
  }
});

// ════════════════════════════════════════════════
//  UTILITY
// ════════════════════════════════════════════════

function formatDate(ts) {
  if (!ts) return '';
  const d = new Date(ts);
  return d.toLocaleDateString(undefined, { month: 'short', day: 'numeric', year: 'numeric' }) +
    ' ' + d.toLocaleTimeString(undefined, { hour: '2-digit', minute: '2-digit' });
}


// ════════════════════════════════════════════════
//  HELP MODAL
// ════════════════════════════════════════════════

function openHelp() {
  document.getElementById('help-modal').classList.add('visible');
}

function closeHelp() {
  document.getElementById('help-modal').classList.remove('visible');
}

// ════════════════════════════════════════════════
//  LIBRARY SYSTEM
// ════════════════════════════════════════════════

let libCurrentItem = null;   // item being edited in modal
let libCurrentRating = 0;
let libFilterType = 'all';
let libFilterStatus = 'all';
let libFilterLinked = 'all';
let libViewMode = 'grid';

const LIB_TYPE_ICONS = { book:'📘', article:'📄', film:'🎬', podcast:'🎙', website:'🌐', other:'📦' };
const LIB_TYPE_LABELS = { book:'Book', article:'Article', film:'Film', podcast:'Podcast', website:'Website', other:'Other' };

function showLibrary() {
  document.getElementById('library-view').classList.add('visible');
  renderLibraryFilters();
  renderLibraryGrid();
}

function hideLibrary() {
  document.getElementById('library-view').classList.remove('visible');
}

function renderLibrarySidebar() {
  const items = Object.values(library);
  const count = items.length;
  const recent = items.sort((a,b) => b.added - a.added).slice(0,5);
  const el = document.getElementById('body-library');
  const countEl = document.getElementById('lib-sidebar-count');
  if (countEl) countEl.textContent = count ? `${count}` : '';
  if (!el) return;
  el.innerHTML = '';
  if (count === 0) {
    el.innerHTML = '<div style="font-size:11.5px;color:var(--text-dim);padding:4px 14px;">No library items</div>';
    return;
  }
  recent.forEach(item => {
    const div = document.createElement('div');
    div.className = 'note-item';
    div.style.paddingLeft = '14px';
    div.innerHTML = `<span class="note-icon">${LIB_TYPE_ICONS[item.type]||'📦'}</span><span class="note-title">${item.title}</span>`;
    div.onclick = () => { showLibrary(); openLibraryItemModal(item.id); };
    el.appendChild(div);
  });
  if (count > 5) {
    const more = document.createElement('div');
    more.style.cssText = 'font-size:11px;color:var(--accent);padding:4px 14px;cursor:pointer;';
    more.textContent = `View all ${count} items →`;
    more.onclick = showLibrary;
    el.appendChild(more);
  }
}

function renderLibraryFilters() {
  const items = Object.values(library);
  const types = ['all','book','article','film','podcast','website','other'];
  types.forEach(t => {
    const el = document.getElementById('lfc-' + t);
    if (!el) return;
    const c = t === 'all' ? items.length : items.filter(i => i.type === t).length;
    el.textContent = c;
  });
  document.getElementById('lib-total-count').textContent = `(${items.length} items)`;
}

function getFilteredLibrary() {
  const q = (document.getElementById('lib-search-input')?.value || '').toLowerCase();
  const sort = document.getElementById('lib-sort-select')?.value || 'added-desc';

  let items = Object.values(library).filter(item => {
    if (libFilterType !== 'all' && item.type !== libFilterType) return false;
    if (libFilterStatus !== 'all' && item.status !== libFilterStatus) return false;
    if (libFilterLinked === 'yes' && (!item.linkedNotes || item.linkedNotes.length === 0)) return false;
    if (libFilterLinked === 'no' && item.linkedNotes && item.linkedNotes.length > 0) return false;
    if (q) {
      const searchable = (item.title + ' ' + item.author + ' ' + item.genre + ' ' + item.tags + ' ' + item.publisher + ' ' + item.isbn).toLowerCase();
      if (!searchable.includes(q)) return false;
    }
    return true;
  });

  // sort
  items.sort((a, b) => {
    switch (sort) {
      case 'added-asc': return a.added - b.added;
      case 'title-asc': return (a.title||'').localeCompare(b.title||'');
      case 'title-desc': return (b.title||'').localeCompare(a.title||'');
      case 'author-asc': return (a.author||'').localeCompare(b.author||'');
      case 'year-desc': return (parseInt(b.year)||0) - (parseInt(a.year)||0);
      case 'rating-desc': return (b.rating||0) - (a.rating||0);
      default: return b.added - a.added;
    }
  });
  return items;
}

function renderLibraryGrid() {
  renderLibraryFilters();
  const items = getFilteredLibrary();
  const container = document.getElementById('lib-items-container');
  const empty = document.getElementById('lib-empty');
  if (!container) return;
  container.innerHTML = '';

  if (Object.keys(library).length === 0) {
    empty.classList.remove('hidden');
    return;
  }
  empty.classList.add('hidden');

  if (items.length === 0) {
    container.innerHTML = '<div style="color:var(--text-dim);font-size:13px;padding:20px;">No items match the current filters.</div>';
    return;
  }

  if (libViewMode === 'grid') {
    container.className = 'lib-grid-layout';
    items.forEach(item => container.appendChild(makeLibCard(item)));
  } else {
    container.className = 'lib-list-layout';
    items.forEach(item => container.appendChild(makeLibRow(item)));
  }
}

function makeLibCard(item) {
  const div = document.createElement('div');
  div.className = 'lib-card';
  const stars = item.rating ? '★'.repeat(item.rating) + '☆'.repeat(5 - item.rating) : '';
  const linkedCount = (item.linkedNotes || []).filter(id => notes[id]).length;
  const coverHtml = item.cover
    ? `<img src="${item.cover}" onerror="this.parentElement.innerHTML='<span class=lib-card-cover-placeholder>${LIB_TYPE_ICONS[item.type]||'📦'}</span>'">`
    : `<span class="lib-card-cover-placeholder">${LIB_TYPE_ICONS[item.type]||'📦'}</span>`;

  div.innerHTML = `
    <div class="lib-card-cover">${coverHtml}</div>
    <div class="lib-card-body">
      <div class="lib-card-title">${escapeHtml(item.title)}</div>
      <div class="lib-card-author">${escapeHtml(item.author || '')}${item.year ? ' · ' + item.year : ''}</div>
      <div class="lib-card-meta">
        <span class="lib-type-badge lib-type-${item.type}">${LIB_TYPE_LABELS[item.type]||item.type}</span>
        <span class="lib-status-badge lib-status-${item.status||'want'}">${statusLabel(item.status)}</span>
        ${stars ? `<span class="lib-rating" title="${item.rating}/5 stars">${stars}</span>` : ''}
        ${linkedCount > 0 ? `<span class="lib-linked-count">🔗 ${linkedCount}</span>` : ''}
      </div>
    </div>`;
  div.onclick = () => openLibraryItemModal(item.id);
  return div;
}

function makeLibRow(item) {
  const div = document.createElement('div');
  div.className = 'lib-row';
  const stars = item.rating ? '★'.repeat(item.rating) : '';
  const linkedCount = (item.linkedNotes || []).filter(id => notes[id]).length;
  div.innerHTML = `
    <div class="lib-row-icon">${LIB_TYPE_ICONS[item.type]||'📦'}</div>
    <div class="lib-row-info">
      <div class="lib-row-title">${escapeHtml(item.title)}</div>
      <div class="lib-row-sub">${escapeHtml(item.author||'')}${item.publisher?' · '+item.publisher:''}${item.year?' · '+item.year:''}</div>
    </div>
    <div class="lib-row-right">
      ${item.isbn ? `<span class="lib-row-isbn">${item.isbn}</span>` : ''}
      ${item.genre ? `<span style="font-size:10.5px;color:var(--text-dim);">${escapeHtml(item.genre)}</span>` : ''}
      <span class="lib-type-badge lib-type-${item.type}">${LIB_TYPE_LABELS[item.type]||item.type}</span>
      <span class="lib-status-badge lib-status-${item.status||'want'}">${statusLabel(item.status)}</span>
      ${stars ? `<span class="lib-rating">${stars}</span>` : ''}
      ${linkedCount > 0 ? `<span class="lib-linked-count">🔗 ${linkedCount}</span>` : ''}
      <div class="lib-row-actions">
        <button class="lib-action-btn" onclick="event.stopPropagation();openLibraryItemModal('${item.id}')" title="Edit">✏️</button>
        <button class="lib-action-btn" onclick="event.stopPropagation();confirmDeleteLib('${item.id}')" title="Delete">🗑</button>
      </div>
    </div>`;
  div.onclick = () => openLibraryItemModal(item.id);
  return div;
}

function statusLabel(s) {
  const map = { want:'Want', reading:'Reading', read:'Read', abandoned:'Abandoned' };
  return map[s] || 'Want';
}

function setLibFilter(kind, value, el) {
  // remove active from siblings
  el.closest('#library-sidebar').querySelectorAll('.lib-filter-item').forEach(i => i.classList.remove('active'));
  el.classList.add('active');
  if (kind === 'type') { libFilterType = value; libFilterStatus = 'all'; libFilterLinked = 'all'; }
  if (kind === 'status') { libFilterStatus = value; libFilterType = 'all'; libFilterLinked = 'all'; }
  if (kind === 'linked') { libFilterLinked = value; libFilterType = 'all'; libFilterStatus = 'all'; }
  renderLibraryGrid();
}

function setLibViewMode(mode) {
  libViewMode = mode;
  document.getElementById('lib-btn-grid').classList.toggle('active', mode === 'grid');
  document.getElementById('lib-btn-list').classList.toggle('active', mode === 'list');
  renderLibraryGrid();
}

// ── LIBRARY ITEM MODAL ──

function openLibraryItemModal(id) {
  libCurrentItem = id ? (library[id] || null) : null;
  libCurrentRating = libCurrentItem ? (libCurrentItem.rating || 0) : 0;

  const titleEl = document.getElementById('lib-item-title-text');
  const deleteBtn = document.getElementById('lib-delete-btn');
  titleEl.textContent = libCurrentItem ? 'Edit Library Item' : 'Add to Library';
  deleteBtn.style.display = libCurrentItem ? 'block' : 'none';

  // Populate fields
  document.getElementById('lib-f-type').value = libCurrentItem?.type || 'book';
  document.getElementById('lib-f-status').value = libCurrentItem?.status || 'want';
  document.getElementById('lib-f-title').value = libCurrentItem?.title || '';
  document.getElementById('lib-f-author').value = libCurrentItem?.author || '';
  document.getElementById('lib-f-year').value = libCurrentItem?.year || '';
  document.getElementById('lib-f-isbn').value = libCurrentItem?.isbn || '';
  document.getElementById('lib-f-publisher').value = libCurrentItem?.publisher || '';
  document.getElementById('lib-f-genre').value = libCurrentItem?.genre || '';
  document.getElementById('lib-f-url').value = libCurrentItem?.url || '';
  document.getElementById('lib-f-cover').value = libCurrentItem?.cover || '';
  document.getElementById('lib-f-tags').value = libCurrentItem?.tags || '';
  document.getElementById('lib-f-notes').value = libCurrentItem?.notes || '';

  updateLibFormByType();
  renderLibRatingStars(libCurrentRating);
  renderLinkedNotesList(libCurrentItem?.linkedNotes || []);
  updateIsbnLink();
  document.getElementById('isbn-lookup-result').style.display = 'none';
  document.getElementById('lib-note-search-results').classList.remove('visible');
  document.getElementById('lib-note-search').value = '';

  document.getElementById('lib-item-modal').classList.add('visible');
  setTimeout(() => document.getElementById('lib-f-title').focus(), 80);
}

function closeLibraryModal() {
  document.getElementById('lib-item-modal').classList.remove('visible');
  document.getElementById('lib-note-search-results').classList.remove('visible');
  libCurrentItem = null;
}

function updateLibFormByType() {
  const type = document.getElementById('lib-f-type').value;
  // Show/hide ISBN row only for books/articles
  const isbnRow = document.getElementById('lib-isbn-row');
  isbnRow.style.display = (type === 'book' || type === 'article') ? 'block' : 'none';
  // Update labels
  const authorLabel = document.getElementById('lib-label-author');
  const publisherLabel = document.getElementById('lib-label-publisher');
  const urlLabel = document.getElementById('lib-label-url');
  if (type === 'film') { authorLabel.textContent = 'Director(s)'; publisherLabel.textContent = 'Studio / Production'; urlLabel.textContent = 'URL / Streaming Link'; }
  else if (type === 'podcast') { authorLabel.textContent = 'Host / Creator'; publisherLabel.textContent = 'Network / Platform'; urlLabel.textContent = 'URL / Feed'; }
  else if (type === 'website') { authorLabel.textContent = 'Author / Organization'; publisherLabel.textContent = 'Website / Platform'; urlLabel.textContent = 'URL *'; }
  else if (type === 'article') { authorLabel.textContent = 'Author(s)'; publisherLabel.textContent = 'Journal / Publisher'; urlLabel.textContent = 'URL / DOI'; }
  else { authorLabel.textContent = 'Author(s)'; publisherLabel.textContent = 'Publisher'; urlLabel.textContent = 'URL / DOI'; }
}

function renderLibRatingStars(rating) {
  libCurrentRating = rating;
  document.querySelectorAll('.lib-star-btn').forEach((btn, i) => {
    btn.classList.toggle('on', i < rating);
  });
  document.getElementById('lib-rating-display').textContent = rating > 0 ? `${rating}/5` : 'Unrated';
}

function setLibRating(val) {
  // clicking same star deselects
  libCurrentRating = (libCurrentRating === val) ? 0 : val;
  renderLibRatingStars(libCurrentRating);
}

function saveLibraryItem() {
  const title = document.getElementById('lib-f-title').value.trim();
  if (!title) { toast('Title is required', 'error'); document.getElementById('lib-f-title').focus(); return; }

  const id = libCurrentItem ? libCurrentItem.id : genId();
  const existing = library[id] || {};

  library[id] = {
    ...existing,
    id,
    type: document.getElementById('lib-f-type').value,
    status: document.getElementById('lib-f-status').value,
    title,
    author: document.getElementById('lib-f-author').value.trim(),
    year: document.getElementById('lib-f-year').value.trim(),
    isbn: document.getElementById('lib-f-isbn').value.trim(),
    publisher: document.getElementById('lib-f-publisher').value.trim(),
    genre: document.getElementById('lib-f-genre').value.trim(),
    url: document.getElementById('lib-f-url').value.trim(),
    cover: document.getElementById('lib-f-cover').value.trim(),
    tags: document.getElementById('lib-f-tags').value.trim(),
    notes: document.getElementById('lib-f-notes').value.trim(),
    rating: libCurrentRating,
    linkedNotes: existing.linkedNotes || [],
    added: existing.added || Date.now(),
    modified: Date.now()
  };

  saveStorage();
  closeLibraryModal();
  renderLibrarySidebar();
  renderLibraryGrid();
  renderLibraryFilters();
  toast(libCurrentItem ? 'Item updated' : 'Added to library', 'success');
}

function deleteLibraryItem() {
  if (!libCurrentItem) return;
  const item = library[libCurrentItem.id];
  if (!item) return;
  if (!confirm(`Delete "${item.title}" from library?`)) return;
  delete library[libCurrentItem.id];
  saveStorage();
  closeLibraryModal();
  renderLibrarySidebar();
  renderLibraryGrid();
  renderLibraryFilters();
  toast('Item removed from library', 'info');
}

function confirmDeleteLib(id) {
  const item = library[id];
  if (!item || !confirm(`Delete "${item.title}"?`)) return;
  delete library[id];
  saveStorage();
  renderLibrarySidebar();
  renderLibraryGrid();
  toast('Item removed', 'info');
}

// ── LINKED NOTES ──

function renderLinkedNotesList(linkedIds) {
  const list = document.getElementById('lib-linked-notes-list');
  list.innerHTML = '';
  const validIds = (linkedIds || []).filter(id => notes[id]);
  if (validIds.length === 0) {
    list.innerHTML = '<div style="font-size:12px;color:var(--text-dim);padding:4px 0;">No notes linked yet.</div>';
    return;
  }
  validIds.forEach(id => {
    const note = notes[id];
    const row = document.createElement('div');
    row.className = 'lib-linked-note-row';
    row.innerHTML = `<span style="font-size:13px;">📄</span>
      <span class="lib-linked-note-title" onclick="closeLibraryModal();openNote('${id}')">${escapeHtml(note.title || 'Untitled')}</span>
      <span style="font-size:10.5px;color:var(--text-dim);">${note.type}</span>
      <button class="lib-unlink-btn" onclick="unlinkNoteFromItem('${id}')" title="Remove link">✕</button>`;
    list.appendChild(row);
  });
}

function unlinkNoteFromItem(noteId) {
  if (!libCurrentItem || !library[libCurrentItem.id]) return;
  library[libCurrentItem.id].linkedNotes = (library[libCurrentItem.id].linkedNotes || []).filter(id => id !== noteId);
  libCurrentItem = library[libCurrentItem.id];
  renderLinkedNotesList(libCurrentItem.linkedNotes);
  saveStorage();
}

function searchNotesForLink(q) {
  const results = document.getElementById('lib-note-search-results');
  if (!q.trim()) { results.classList.remove('visible'); return; }
  const ql = q.toLowerCase();
  const matches = Object.values(notes).filter(n => (n.title||'').toLowerCase().includes(ql)).slice(0, 8);
  results.innerHTML = '';
  if (matches.length === 0) { results.classList.remove('visible'); return; }
  results.classList.add('visible');
  matches.forEach(n => {
    const div = document.createElement('div');
    div.className = 'lib-note-suggestion';
    div.textContent = n.title || 'Untitled';
    div.onclick = () => linkNoteToItem(n.id);
    results.appendChild(div);
  });
}

function linkNoteToItem(noteId) {
  // Get current linked notes from the displayed list (even before save)
  const listRows = document.getElementById('lib-linked-notes-list').querySelectorAll('.lib-linked-note-title');
  const currentIds = Array.from(listRows).map(r => {
    const btn = r.nextElementSibling?.nextElementSibling;
    if (btn) { const m = btn.getAttribute('onclick')?.match(/'([^']+)'/); return m ? m[1] : null; }
    return null;
  }).filter(Boolean);

  // Also check from libCurrentItem
  const base = libCurrentItem ? (library[libCurrentItem.id]?.linkedNotes || []) : [];
  const allIds = [...new Set([...base, ...currentIds])];

  if (allIds.includes(noteId)) {
    toast('Already linked', 'info');
    document.getElementById('lib-note-search-results').classList.remove('visible');
    document.getElementById('lib-note-search').value = '';
    return;
  }
  const newIds = [...allIds, noteId];

  if (libCurrentItem && library[libCurrentItem.id]) {
    library[libCurrentItem.id].linkedNotes = newIds;
    libCurrentItem = library[libCurrentItem.id];
    saveStorage();
  } else {
    // Store temporarily for new items (will be saved on save)
    if (!libCurrentItem) libCurrentItem = { linkedNotes: newIds };
    else libCurrentItem.linkedNotes = newIds;
  }
  renderLinkedNotesList(newIds);
  document.getElementById('lib-note-search-results').classList.remove('visible');
  document.getElementById('lib-note-search').value = '';
  toast('Note linked', 'success');
}

// ── ISBN LOOKUP ──

function updateIsbnLink() {
  const isbn = document.getElementById('lib-f-isbn').value.trim().replace(/[-\s]/g, '');
  const link = document.getElementById('lib-openlibrary-link');
  if (!link) return;
  if (isbn) {
    link.href = `https://openlibrary.org/isbn/${isbn}`;
    link.style.opacity = '1';
  } else {
    link.href = '#';
    link.style.opacity = '0.5';
  }
}

async function isbnLookup() {
  const isbn = document.getElementById('lib-f-isbn').value.trim().replace(/[-\s]/g, '');
  if (!isbn) { toast('Enter an ISBN first', 'error'); return; }
  const resultEl = document.getElementById('isbn-lookup-result');
  resultEl.style.display = 'block';
  resultEl.textContent = '⏳ Looking up…';
  resultEl.style.color = 'var(--text-muted)';
  resultEl.style.background = 'var(--bg)';
  resultEl.style.borderColor = 'var(--border)';

  try {
    const res = await fetch(`https://openlibrary.org/isbn/${isbn}.json`);
    if (!res.ok) throw new Error('Not found');
    const data = await res.json();

    // Get author names (requires separate calls or use works)
    let authorStr = '';
    if (data.authors && data.authors.length > 0) {
      // Try to fetch first author
      try {
        const authRes = await fetch(`https://openlibrary.org${data.authors[0].key}.json`);
        const authData = await authRes.json();
        authorStr = authData.name || '';
        if (data.authors.length > 1) authorStr += (data.authors.length === 2 ? ', and [co-author]' : ', et al.');
      } catch {}
    }

    // Fill fields
    if (data.title) document.getElementById('lib-f-title').value = data.title;
    if (authorStr) document.getElementById('lib-f-author').value = authorStr;
    if (data.publishers?.[0]) document.getElementById('lib-f-publisher').value = data.publishers[0];
    if (data.publish_date) {
      const year = data.publish_date.match(/\d{4}/)?.[0] || '';
      document.getElementById('lib-f-year').value = year;
    }
    if (data.subjects?.[0]) document.getElementById('lib-f-genre').value = data.subjects.slice(0,3).join(', ');
    // Cover
    const coverId = data.covers?.[0];
    if (coverId && coverId > 0) {
      document.getElementById('lib-f-cover').value = `https://covers.openlibrary.org/b/id/${coverId}-M.jpg`;
    }
    resultEl.textContent = '✓ Data filled from Open Library';
    resultEl.style.color = 'var(--green)';
    resultEl.style.background = 'rgba(74,222,128,0.1)';
    resultEl.style.borderColor = 'rgba(74,222,128,0.3)';
    toast('ISBN data loaded', 'success');
  } catch (err) {
    resultEl.textContent = '✗ Not found — try manually or check the ISBN';
    resultEl.style.color = 'var(--red)';
    resultEl.style.background = 'rgba(248,113,113,0.1)';
    resultEl.style.borderColor = 'rgba(248,113,113,0.3)';
  }
}

// ── LIBRARY EXPORT ──

function exportLibraryExcel() {
  const rows = [['ID','Type','Title','Author','Year','ISBN','Publisher','Genre','Status','Rating','Tags','URL','Linked Notes','Date Added']];
  Object.values(library).forEach(item => {
    const linked = (item.linkedNotes||[]).filter(id=>notes[id]).map(id=>notes[id].title||'Untitled').join('; ');
    rows.push([
      item.id, item.type, item.title, item.author||'', item.year||'',
      item.isbn||'', item.publisher||'', item.genre||'',
      item.status||'', item.rating||'', item.tags||'', item.url||'',
      linked, new Date(item.added).toLocaleDateString()
    ]);
  });
  const ws = XLSX.utils.aoa_to_sheet(rows);
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, 'Library');
  XLSX.writeFile(wb, 'zettelkasten-library.xlsx');
  toast('Library exported to Excel', 'success');
}

function exportLibraryJSON() {
  downloadFile('zettelkasten-library.json', JSON.stringify(library, null, 2), 'application/json');
  toast('Library exported as JSON', 'success');
}

// ── HELPER ──

function escapeHtml(str) {
  if (!str) return '';
  return str.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}

// ════════════════════════════════════════════════
//  LIBRARY → CITATION BRIDGE
// ════════════════════════════════════════════════

function toggleLibImportDropdown() {
  const dropdown = document.getElementById('lib-import-dropdown');
  if (!dropdown) return;
  if (dropdown.classList.contains('visible')) {
    dropdown.classList.remove('visible');
    return;
  }
  // Populate with library items
  const items = Object.values(library).filter(i => i.type === 'book' || i.type === 'article' || i.type === 'website' || i.type === 'podcast');
  if (items.length === 0) {
    dropdown.innerHTML = '<div style="padding:10px 12px;font-size:12px;color:var(--text-dim);">No library items yet — add some in the Library section.</div>';
  } else {
    dropdown.innerHTML = items.map(item => `
      <div class="lib-import-item" onclick="importLibItemToCitation('${item.id}')">
        <span class="lib-import-icon">${LIB_TYPE_ICONS[item.type]||'📦'}</span>
        <div class="lib-import-info">
          <div class="lib-import-title">${escapeHtml(item.title)}</div>
          <div class="lib-import-sub">${escapeHtml(item.author||'')}${item.year?' · '+item.year:''}</div>
        </div>
      </div>`).join('');
  }
  dropdown.classList.add('visible');

  // Close on outside click
  setTimeout(() => {
    const close = (e) => {
      if (!dropdown.contains(e.target)) {
        dropdown.classList.remove('visible');
        document.removeEventListener('click', close);
      }
    };
    document.addEventListener('click', close);
  }, 50);
}

const LIB_TYPE_TO_CITE_TYPE = { book: 'book', article: 'journal', film: 'film', podcast: 'podcast', website: 'website', other: 'other' };

function importLibItemToCitation(libId) {
  const item = library[libId];
  if (!item || !currentNoteId || !notes[currentNoteId]) {
    toast('Open a note first', 'error'); return;
  }
  const citeType = LIB_TYPE_TO_CITE_TYPE[item.type] || 'book';

  // Map library fields → citation fields
  document.getElementById('cite-type').value = citeType;
  document.getElementById('cite-authors').value = item.author || '';
  document.getElementById('cite-source-title').value = item.title || '';
  document.getElementById('cite-publisher').value = item.publisher || '';
  document.getElementById('cite-pub-date').value = item.year || '';
  document.getElementById('cite-location').value = item.url || '';

  // Save to note
  onCiteFieldChange();

  // Expand citation panel
  const body = document.getElementById('citation-body');
  const icon = document.getElementById('citation-toggle-icon');
  body.classList.add('open');
  icon.classList.add('open');
  if (notes[currentNoteId].citation) notes[currentNoteId].citation.expanded = true;
  saveStorage();

  document.getElementById('lib-import-dropdown').classList.remove('visible');
  toast(`Imported "${item.title}" to citation`, 'success');
}

// ════════════════════════════════════════════════
//  INLINE CITATION INSERT
// ════════════════════════════════════════════════

function insertInlineCitation() {
  const c = notes[currentNoteId]?.citation;
  if (!c?.generated) return;
  // Extract author last name and year for inline format: (Author, Year)
  const authorsRaw = c.authors || '';
  const firstAuthor = authorsRaw.split(',')[0].trim();
  const lastNameOnly = firstAuthor.split(' ')[0]; // last name is first in "Last, First" format
  const year = c.pubDate ? (c.pubDate.match(/\d{4}/)?.[0] || '') : '';
  const inline = lastNameOnly ? `(${lastNameOnly}${year ? ', ' + year : ''})` : '(citation)';

  const editor = document.getElementById('markdown-editor');
  const start = editor.selectionStart;
  const end = editor.selectionEnd;
  const val = editor.value;
  editor.value = val.slice(0, start) + inline + val.slice(end);
  editor.setSelectionRange(start + inline.length, start + inline.length);
  editor.focus();
  onEditorChange(editor.value);
  toast('Inline citation inserted', 'success');
}

// ════════════════════════════════════════════════
//  BACKUP REMINDER
// ════════════════════════════════════════════════

function checkBackupReminder() {
  const noteCount = Object.keys(notes).length;
  if (noteCount < 5) return; // don't bother until user has real content
  const lastDismissed = localStorage.getItem('zk_backup_dismissed');
  const lastExported = localStorage.getItem('zk_last_exported');
  const now = Date.now();
  // Show if: never dismissed, or dismissed > 7 days ago, and never exported or exported > 7 days ago
  const sevenDays = 7 * 24 * 60 * 60 * 1000;
  const shouldShow = (!lastDismissed || now - parseInt(lastDismissed) > sevenDays) &&
                     (!lastExported || now - parseInt(lastExported) > sevenDays);
  if (shouldShow) {
    document.getElementById('backup-note-count').textContent = noteCount + ' notes';
    document.getElementById('backup-banner').classList.add('visible');
  }
}

function dismissBackupBanner() {
  document.getElementById('backup-banner').classList.remove('visible');
  localStorage.setItem('zk_backup_dismissed', Date.now().toString());
}

// ════════════════════════════════════════════════
//  SPLIT VIEW DRAG HANDLE
// ════════════════════════════════════════════════

function initSplitDrag() {
  const handle = document.getElementById('split-drag-handle');
  const editorPane = document.getElementById('editor-pane');
  const previewPane = document.getElementById('preview-pane');
  const split = document.getElementById('editor-split');
  if (!handle || !editorPane || !previewPane) return;

  let dragging = false, startX = 0, startWidth = 0;

  handle.addEventListener('mousedown', e => {
    dragging = true;
    startX = e.clientX;
    startWidth = editorPane.getBoundingClientRect().width;
    handle.classList.add('dragging');
    document.body.style.cursor = 'col-resize';
    document.body.style.userSelect = 'none';
    e.preventDefault();
  });

  document.addEventListener('mousemove', e => {
    if (!dragging) return;
    const totalWidth = split.getBoundingClientRect().width - 5; // minus handle
    const newWidth = Math.max(180, Math.min(startWidth + (e.clientX - startX), totalWidth - 180));
    editorPane.style.width = newWidth + 'px';
    editorPane.style.flex = 'none';
    previewPane.style.flex = '1';
    settings.splitRatio = newWidth / totalWidth;
  });

  document.addEventListener('mouseup', () => {
    if (!dragging) return;
    dragging = false;
    handle.classList.remove('dragging');
    document.body.style.cursor = '';
    document.body.style.userSelect = '';
    saveSettings();
  });
}

// ════════════════════════════════════════════════
//  SIDEBAR RESIZE HANDLE
// ════════════════════════════════════════════════

function initSidebarResize() {
  const handle = document.getElementById('sidebar-resize-handle');
  const sidebar = document.getElementById('sidebar');
  if (!handle || !sidebar) return;

  let dragging = false, startX = 0, startWidth = 0;

  handle.addEventListener('mousedown', e => {
    dragging = true;
    startX = e.clientX;
    startWidth = sidebar.getBoundingClientRect().width;
    handle.classList.add('dragging');
    document.body.style.cursor = 'col-resize';
    document.body.style.userSelect = 'none';
    e.preventDefault();
    e.stopPropagation();
  });

  document.addEventListener('mousemove', e => {
    if (!dragging) return;
    const newWidth = Math.max(180, Math.min(startWidth + (e.clientX - startX), 500));
    sidebar.style.width = newWidth + 'px';
    document.documentElement.style.setProperty('--sidebar-width', newWidth + 'px');
  });

  document.addEventListener('mouseup', () => {
    if (!dragging) return;
    dragging = false;
    handle.classList.remove('dragging');
    document.body.style.cursor = '';
    document.body.style.userSelect = '';
    settings.sidebarWidth = parseInt(sidebar.style.width) || 260;
    saveSettings();
  });
}

// ════════════════════════════════════════════════
//  STAR CURRENT NOTE SHORTCUT
// ════════════════════════════════════════════════

function starCurrentNote() {
  if (!currentNoteId || !notes[currentNoteId]) return;
  toggleStar(currentNoteId);
}

// ════════════════════════════════════════════════
//  INIT
// ════════════════════════════════════════════════

function init() {
  load();
  applyTheme();
  applyEditorFont();

  // Restore sidebar width
  if (settings.sidebarWidth) {
    const sidebar = document.getElementById('sidebar');
    if (sidebar) {
      sidebar.style.width = settings.sidebarWidth + 'px';
      document.documentElement.style.setProperty('--sidebar-width', settings.sidebarWidth + 'px');
    }
  }

  renderSidebar();

  // Init drag handles
  initSplitDrag();
  initSidebarResize();

  // ISBN input live update for Open Library link
  document.getElementById('lib-f-isbn').addEventListener('input', updateIsbnLink);

  // Show backup reminder after a short delay
  setTimeout(checkBackupReminder, 3000);

  // If there are notes, open the most recent
  if (Object.keys(notes).length > 0) {
    if (recentNotes.length > 0 && notes[recentNotes[0]]) {
      openNote(recentNotes[0]);
    } else {
      const firstNote = Object.values(notes)[0];
      openNote(firstNote.id);
    }
  } else {
    showEmptyState();
    // Create a welcome note
    setTimeout(() => {
      const welcomeId = createNote({
        title: 'Welcome to Zettelkasten',
        type: 'permanent',
        body: `# Welcome to Zettelkasten ✦

This is your personal knowledge management system, inspired by Obsidian. Here's what you can do:

## Getting Started

- **Create notes** with Alt+N
- **Open the command palette** with Alt+K to quickly navigate
- **Open today's daily note** with Alt+D
- **Search** with Alt+F

## Core Features

### Bidirectional Linking
Link notes with [[double brackets]]. For example: [[Welcome to Zettelkasten]]

### Tags
Add tags anywhere with #productivity or #zettelkasten. They appear in the sidebar tag browser.

### Note Types
- **Fleeting** 🟠 — Quick captures and passing thoughts
- **Literature** 🔵 — Notes from books, articles, sources
- **Permanent** 🟢 — Refined, atomic ideas

### Graph View
Press Alt+G to see all your notes as an interactive knowledge graph.

### Citation System
For Literature notes, the Source/Citation panel lets you generate MLA 9th edition citations automatically. Click the 📖 button in the toolbar.

## Tips

> The best Zettelkasten is the one you actually use.

Start with **fleeting notes** — capture ideas quickly without overthinking. Later, refine them into **permanent notes** with atomic, standalone ideas that [[link]] to other notes.

#zettelkasten #welcome #productivity
`
      });
    }, 100);
  }
}

init();
</script>
</body>
</html>
